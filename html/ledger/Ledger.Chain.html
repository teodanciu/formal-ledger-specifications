<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Ledger.Chain</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda"><a id="1" class="Background">\section{Blockchain layer}

</a><a id="29" class="Markup">\begin{code}[hide]</a>
<a id="48" class="Symbol">{-#</a> <a id="52" class="Keyword">OPTIONS</a> <a id="60" class="Pragma">--safe</a> <a id="67" class="Symbol">#-}</a>

<a id="72" class="Keyword">open</a> <a id="77" class="Keyword">import</a> <a id="84" href="Algebra.html" class="Module">Algebra</a>
<a id="92" class="Keyword">open</a> <a id="97" class="Keyword">import</a> <a id="104" href="Data.Maybe.html" class="Module">Data.Maybe</a> <a id="115" class="Keyword">using</a> <a id="121" class="Symbol">(</a><a id="122" href="Data.Maybe.Base.html#2242" class="Function Operator">_&gt;&gt;=_</a><a id="127" class="Symbol">)</a>
<a id="129" class="Keyword">open</a> <a id="134" class="Keyword">import</a> <a id="141" href="Data.Nat.Properties.html" class="Module">Data.Nat.Properties</a> <a id="161" class="Keyword">using</a> <a id="167" class="Symbol">(</a><a id="168" href="Data.Nat.Properties.html#16387" class="Function">+-0-monoid</a><a id="178" class="Symbol">;</a> <a id="180" href="Data.Nat.Properties.html#16466" class="Function">+-0-commutativeMonoid</a><a id="201" class="Symbol">)</a>

<a id="204" class="Keyword">open</a> <a id="209" class="Keyword">import</a> <a id="216" href="Ledger.Prelude.html" class="Module">Ledger.Prelude</a><a id="230" class="Symbol">;</a> <a id="232" class="Keyword">open</a> <a id="237" href="Function.Bundles.html#4340" class="Module">Equivalence</a>
<a id="249" class="Keyword">open</a> <a id="254" class="Keyword">import</a> <a id="261" href="Ledger.Transaction.html" class="Module">Ledger.Transaction</a>

<a id="281" class="Keyword">module</a> <a id="288" href="Ledger.Chain.html" class="Module">Ledger.Chain</a> <a id="301" class="Symbol">(</a><a id="302" href="Ledger.Chain.html#302" class="Bound">txs</a> <a id="306" class="Symbol">:</a> <a id="308" class="Symbol">_)</a> <a id="311" class="Symbol">(</a><a id="312" class="Keyword">open</a> <a id="317" href="Ledger.Transaction.html#617" class="Module">TransactionStructure</a> <a id="338" href="Ledger.Chain.html#302" class="Bound">txs</a><a id="341" class="Symbol">)</a> <a id="343" class="Keyword">where</a>

<a id="350" class="Keyword">open</a> <a id="355" class="Keyword">import</a> <a id="362" href="Ledger.Gov.html" class="Module">Ledger.Gov</a> <a id="373" href="Ledger.Transaction.html#2486" class="Function">govStructure</a>
<a id="386" class="Keyword">open</a> <a id="391" class="Keyword">import</a> <a id="398" href="Ledger.Ledger.html" class="Module">Ledger.Ledger</a> <a id="412" href="Ledger.Chain.html#302" class="Bound">txs</a>
<a id="416" class="Keyword">open</a> <a id="421" class="Keyword">import</a> <a id="428" href="Ledger.Ratify.html" class="Module">Ledger.Ratify</a> <a id="442" href="Ledger.Chain.html#302" class="Bound">txs</a>
<a id="446" class="Keyword">open</a> <a id="451" class="Keyword">import</a> <a id="458" href="Ledger.Utxo.html" class="Module">Ledger.Utxo</a> <a id="470" href="Ledger.Chain.html#302" class="Bound">txs</a>
<a id="474" class="Markup">\end{code}</a><a id="484" class="Background">
\begin{figure*}[h]
</a><a id="504" class="Markup">\begin{code}</a>

<a id="518" class="Keyword">record</a> <a id="NewEpochEnv"></a><a id="525" href="Ledger.Chain.html#525" class="Record">NewEpochEnv</a> <a id="537" class="Symbol">:</a> <a id="539" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="543" class="Keyword">where</a>
  <a id="551" class="Keyword">field</a> <a id="NewEpochEnv.stakeDistrs"></a><a id="557" href="Ledger.Chain.html#557" class="Field">stakeDistrs</a> <a id="569" class="Symbol">:</a> <a id="571" href="Ledger.Ratify.html#4586" class="Record">StakeDistrs</a>
   <a id="586" class="Comment">-- TODO: compute this from LState instead</a>

<a id="629" class="Keyword">record</a> <a id="NewEpochState"></a><a id="636" href="Ledger.Chain.html#636" class="Record">NewEpochState</a> <a id="650" class="Symbol">:</a> <a id="652" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="656" class="Keyword">where</a>
  <a id="664" class="Keyword">constructor</a> <a id="⟦_,_,_,_,_⟧ⁿᵉ"></a><a id="676" href="Ledger.Chain.html#676" class="InductiveConstructor Operator">⟦_,_,_,_,_⟧ⁿᵉ</a>
  <a id="692" class="Keyword">field</a> <a id="NewEpochState.lastEpoch"></a><a id="698" href="Ledger.Chain.html#698" class="Field">lastEpoch</a>  <a id="709" class="Symbol">:</a> <a id="711" href="Ledger.Epoch.html#502" class="Function">Epoch</a>
        <a id="NewEpochState.acnt"></a><a id="725" href="Ledger.Chain.html#725" class="Field">acnt</a>       <a id="736" class="Symbol">:</a> <a id="738" href="Ledger.PParams.html#716" class="Record">Acnt</a>
        <a id="NewEpochState.ls"></a><a id="751" href="Ledger.Chain.html#751" class="Field">ls</a>         <a id="762" class="Symbol">:</a> <a id="764" href="Ledger.Ledger.html#716" class="Record">LState</a>
        <a id="NewEpochState.es"></a><a id="779" href="Ledger.Chain.html#779" class="Field">es</a>         <a id="790" class="Symbol">:</a> <a id="792" href="Ledger.GovernanceActions.html#11944" class="Record">EnactState</a>
        <a id="NewEpochState.fut"></a><a id="811" href="Ledger.Chain.html#811" class="Field">fut</a>        <a id="822" class="Symbol">:</a> <a id="824" href="Ledger.Ratify.html#4876" class="Record">RatifyState</a>

<a id="837" class="Keyword">record</a> <a id="ChainState"></a><a id="844" href="Ledger.Chain.html#844" class="Record">ChainState</a> <a id="855" class="Symbol">:</a> <a id="857" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="861" class="Keyword">where</a>
  <a id="869" class="Keyword">field</a> <a id="ChainState.newEpochState"></a><a id="875" href="Ledger.Chain.html#875" class="Field">newEpochState</a>  <a id="890" class="Symbol">:</a> <a id="892" href="Ledger.Chain.html#636" class="Record">NewEpochState</a>

<a id="907" class="Keyword">record</a> <a id="Block"></a><a id="914" href="Ledger.Chain.html#914" class="Record">Block</a> <a id="920" class="Symbol">:</a> <a id="922" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="926" class="Keyword">where</a>
  <a id="934" class="Keyword">field</a> <a id="Block.ts"></a><a id="940" href="Ledger.Chain.html#940" class="Field">ts</a>    <a id="946" class="Symbol">:</a> <a id="948" href="Agda.Builtin.List.html#130" class="Datatype">List</a> <a id="953" href="Ledger.Transaction.html#4052" class="Record">Tx</a>
        <a id="Block.slot"></a><a id="964" href="Ledger.Chain.html#964" class="Field">slot</a>  <a id="970" class="Symbol">:</a> <a id="972" href="Ledger.Epoch.html#548" class="Function">Slot</a>
<a id="977" class="Markup">\end{code}</a><a id="987" class="Background">
\caption{Definitions for the NEWEPOCH and CHAIN transition systems}
\end{figure*}
</a><a id="1070" class="Markup">\begin{code}[hide]</a>
<a id="1089" class="Keyword">private</a> <a id="1097" class="Keyword">variable</a>
  <a id="1108" href="Ledger.Chain.html#1108" class="Generalizable">s</a> <a id="1110" class="Symbol">:</a> <a id="1112" href="Ledger.Chain.html#844" class="Record">ChainState</a>
  <a id="1125" href="Ledger.Chain.html#1125" class="Generalizable">b</a> <a id="1127" class="Symbol">:</a> <a id="1129" href="Ledger.Chain.html#914" class="Record">Block</a>
  <a id="1137" href="Ledger.Chain.html#1137" class="Generalizable">ls&#39;</a> <a id="1141" class="Symbol">:</a> <a id="1143" href="Ledger.Ledger.html#716" class="Record">LState</a>
  <a id="1152" href="Ledger.Chain.html#1152" class="Generalizable">nes</a> <a id="1156" class="Symbol">:</a> <a id="1158" href="Ledger.Chain.html#636" class="Record">NewEpochState</a>
  <a id="1174" href="Ledger.Chain.html#1174" class="Generalizable">e</a> <a id="1176" class="Symbol">:</a> <a id="1178" href="Ledger.Epoch.html#502" class="Function">Epoch</a>
  <a id="1186" href="Ledger.Chain.html#1186" class="Generalizable">es&#39;</a> <a id="1190" class="Symbol">:</a> <a id="1192" href="Ledger.GovernanceActions.html#11944" class="Record">EnactState</a>
  <a id="1205" href="Ledger.Chain.html#1205" class="Generalizable">govSt&#39;</a> <a id="1212" class="Symbol">:</a> <a id="1214" href="Ledger.Gov.html#899" class="Function">GovState</a>
  <a id="1225" href="Ledger.Chain.html#1225" class="Generalizable">d</a> <a id="1227" class="Symbol">:</a> <a id="1229" href="Agda.Builtin.Bool.html#156" class="Datatype">Bool</a>
  <a id="1236" href="Ledger.Chain.html#1236" class="Generalizable">fut&#39;</a> <a id="1241" class="Symbol">:</a> <a id="1243" href="Ledger.Ratify.html#4876" class="Record">RatifyState</a>

<a id="1256" class="Keyword">instance</a> <a id="1265" href="Ledger.Chain.html#1265" class="Function">_</a> <a id="1267" class="Symbol">=</a> <a id="1269" href="Data.Nat.Properties.html#16387" class="Function">+-0-monoid</a><a id="1279" class="Symbol">;</a> <a id="1281" href="Ledger.Chain.html#1281" class="Function">_</a> <a id="1283" class="Symbol">=</a> <a id="1285" href="Data.Nat.Properties.html#16466" class="Function">+-0-commutativeMonoid</a>

<a id="1308" class="Comment">-- The NEWEPOCH rule is actually multiple rules in one for the sake of simplicity:t also does what EPOCH used to do in previous eras</a>
<a id="1441" class="Keyword">data</a> <a id="_⊢_⇀⦇_,NEWEPOCH⦈_"></a><a id="1446" href="Ledger.Chain.html#1446" class="Datatype Operator">_⊢_⇀⦇_,NEWEPOCH⦈_</a> <a id="1464" class="Symbol">:</a> <a id="1466" href="Ledger.Chain.html#525" class="Record">NewEpochEnv</a> <a id="1478" class="Symbol">→</a> <a id="1480" href="Ledger.Chain.html#636" class="Record">NewEpochState</a> <a id="1494" class="Symbol">→</a> <a id="1496" href="Ledger.Epoch.html#502" class="Function">Epoch</a> <a id="1502" class="Symbol">→</a> <a id="1504" href="Ledger.Chain.html#636" class="Record">NewEpochState</a> <a id="1518" class="Symbol">→</a> <a id="1520" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="1524" class="Keyword">where</a>
<a id="1530" class="Markup">\end{code}</a><a id="1540" class="Background">
\begin{figure*}[h]
</a><a id="1560" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,NEWEPOCH⦈_.NEWEPOCH-New"></a><a id="1575" href="Ledger.Chain.html#1575" class="InductiveConstructor">NEWEPOCH-New</a> <a id="1588" class="Symbol">:</a> <a id="1590" class="Symbol">∀</a> <a id="1592" class="Symbol">{</a><a id="1593" href="Ledger.Chain.html#1593" class="Bound">Γ</a><a id="1594" class="Symbol">}</a> <a id="1596" class="Symbol">→</a> <a id="1598" class="Keyword">let</a>
      <a id="1608" class="Keyword">open</a> <a id="1613" href="Ledger.Chain.html#636" class="Module">NewEpochState</a> <a id="1627" href="Ledger.Chain.html#1152" class="Generalizable">nes</a> <a id="1631" class="Keyword">hiding</a> <a id="1638" class="Symbol">(</a><a id="1639" href="Ledger.Chain.html#779" class="Field">es</a><a id="1641" class="Symbol">)</a>
      <a id="1649" class="Keyword">open</a> <a id="1654" href="Ledger.Ratify.html#4876" class="Module">RatifyState</a> <a id="1666" href="Ledger.Chain.html#811" class="Function">fut</a> <a id="1670" class="Keyword">using</a> <a id="1676" class="Symbol">(</a><a id="1677" href="Ledger.Ratify.html#4968" class="Field">removed</a><a id="1684" class="Symbol">)</a> <a id="1686" class="Keyword">renaming</a> <a id="1695" class="Symbol">(</a><a id="1696" href="Ledger.Ratify.html#4931" class="Field">es</a> <a id="1699" class="Symbol">to</a> <a id="1702" class="Field">esW</a><a id="1705" class="Symbol">)</a>
      <a id="1713" class="Comment">-- ^ this rolls over the future enact state into es</a>
      <a id="1771" class="Keyword">open</a> <a id="1776" href="Ledger.Ledger.html#716" class="Module">LState</a> <a id="1783" href="Ledger.Chain.html#751" class="Function">ls</a><a id="1785" class="Symbol">;</a> <a id="1787" class="Keyword">open</a> <a id="1792" href="Ledger.Utxo.html#4386" class="Module">UTxOState</a> <a id="1802" href="Ledger.Ledger.html#766" class="Function">utxoSt</a>
      <a id="1815" class="Keyword">open</a> <a id="1820" href="Ledger.Deleg.html#1344" class="Module">CertState</a> <a id="1830" href="Ledger.Ledger.html#827" class="Function">certState</a>
      <a id="1846" class="Keyword">open</a> <a id="1851" href="Ledger.Deleg.html#1074" class="Module">PState</a> <a id="1858" href="Ledger.Deleg.html#1421" class="Function">pState</a><a id="1864" class="Symbol">;</a> <a id="1866" class="Keyword">open</a> <a id="1871" href="Ledger.Deleg.html#816" class="Module">DState</a> <a id="1878" href="Ledger.Deleg.html#1397" class="Function">dState</a><a id="1884" class="Symbol">;</a> <a id="1886" class="Keyword">open</a> <a id="1891" href="Ledger.Deleg.html#1205" class="Module">GState</a> <a id="1898" href="Ledger.Deleg.html#1445" class="Function">gState</a>
      <a id="1911" class="Keyword">open</a> <a id="1916" href="Ledger.PParams.html#716" class="Module">Acnt</a> <a id="1921" href="Ledger.Chain.html#725" class="Function">acnt</a>

      <a id="1933" href="Ledger.Chain.html#1933" class="Bound">trWithdrawals</a>   <a id="1949" class="Symbol">=</a> <a id="1951" href="Ledger.Chain.html#1702" class="Function">esW</a> <a id="1955" class="Symbol">.</a><a id="1956" href="Ledger.GovernanceActions.html#12205" class="Field">EnactState.withdrawals</a>
      <a id="1985" href="Ledger.Chain.html#1985" class="Bound">totWithdrawals</a>  <a id="2001" class="Symbol">=</a> <a id="2003" href="Axiom.Set.Sum.html#4411" class="Function">Σᵐᵛ[</a> <a id="2008" href="Ledger.Chain.html#2008" class="Bound">x</a> <a id="2010" href="Axiom.Set.Sum.html#4411" class="Function">←</a> <a id="2012" href="Ledger.Chain.html#1933" class="Bound">trWithdrawals</a> <a id="2026" href="Ledger.Prelude.html#3690" class="Function Operator">ᶠᵐ</a> <a id="2029" href="Axiom.Set.Sum.html#4411" class="Function">]</a> <a id="2031" href="Ledger.Chain.html#2008" class="Bound">x</a>

      <a id="2040" href="Ledger.Chain.html#2040" class="Bound">removedGovActions</a> <a id="2058" class="Symbol">=</a> <a id="2060" href="Function.Base.html#1629" class="Function">flip</a> <a id="2065" href="Axiom.Set.html#6790" class="Function">concatMapˢ</a> <a id="2076" href="Ledger.Ratify.html#4968" class="Function">removed</a> <a id="2084" class="Symbol">λ</a> <a id="2086" class="Symbol">(</a><a id="2087" href="Ledger.Chain.html#2087" class="Bound">gaid</a> <a id="2092" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="2094" href="Ledger.Chain.html#2094" class="Bound">gaSt</a><a id="2098" class="Symbol">)</a> <a id="2100" class="Symbol">→</a>
        <a id="2110" href="Ledger.Prelude.html#1544" class="Function">mapˢ</a> <a id="2115" class="Symbol">(</a><a id="2116" href="Ledger.Gov.html#777" class="Field">GovActionState.returnAddr</a> <a id="2142" href="Ledger.Chain.html#2094" class="Bound">gaSt</a> <a id="2147" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,_</a><a id="2149" class="Symbol">)</a>
             <a id="2164" class="Symbol">((</a><a id="2166" href="Ledger.Utxo.html#4493" class="Function">deposits</a> <a id="2175" href="Axiom.Set.Map.html#8760" class="Function Operator">∣</a> <a id="2177" href="Axiom.Set.html#5995" class="Function Operator">❴</a> <a id="2179" href="Ledger.Utxo.html#2160" class="InductiveConstructor">GovActionDeposit</a> <a id="2196" href="Ledger.Chain.html#2087" class="Bound">gaid</a> <a id="2201" href="Axiom.Set.html#5995" class="Function Operator">❵</a><a id="2202" class="Symbol">)</a> <a id="2204" href="Axiom.Set.Map.html#2295" class="Function Operator">ˢ</a><a id="2205" class="Symbol">)</a>
      <a id="2213" href="Ledger.Chain.html#2213" class="Bound">govActionReturns</a> <a id="2230" class="Symbol">=</a> <a id="2232" href="Axiom.Set.Map.Dec.html#1919" class="Function">aggregate₊</a> <a id="2243" href="Function.Base.html#1994" class="Function Operator">$</a> <a id="2245" href="Ledger.Prelude.html#1544" class="Function">mapˢ</a> <a id="2250" class="Symbol">(λ</a> <a id="2253" class="Symbol">(</a><a id="2254" href="Ledger.Chain.html#2254" class="Bound">a</a> <a id="2256" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="2258" class="Symbol">_</a> <a id="2260" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="2262" href="Ledger.Chain.html#2262" class="Bound">d</a><a id="2263" class="Symbol">)</a> <a id="2265" class="Symbol">→</a> <a id="2267" href="Ledger.Chain.html#2254" class="Bound">a</a> <a id="2269" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="2271" href="Ledger.Chain.html#2262" class="Bound">d</a><a id="2272" class="Symbol">)</a> <a id="2274" href="Ledger.Chain.html#2040" class="Bound">removedGovActions</a> <a id="2292" href="Ledger.Prelude.html#3772" class="Function Operator">ᶠˢ</a>

      <a id="2302" href="Ledger.Chain.html#2302" class="Bound">es</a>        <a id="2312" class="Symbol">=</a> <a id="2314" class="Keyword">record</a> <a id="2321" href="Ledger.Chain.html#1702" class="Function">esW</a> <a id="2325" class="Symbol">{</a> <a id="2327" href="Ledger.GovernanceActions.html#12205" class="Field">withdrawals</a> <a id="2339" class="Symbol">=</a> <a id="2341" href="Axiom.Set.Map.html#2741" class="Function">∅ᵐ</a> <a id="2344" class="Symbol">}</a>
      <a id="2352" href="Ledger.Chain.html#2352" class="Bound">retired</a>   <a id="2362" class="Symbol">=</a> <a id="2364" href="Ledger.Deleg.html#1166" class="Function">retiring</a> <a id="2373" href="Axiom.Set.Map.html#10896" class="Function Operator">⁻¹</a> <a id="2376" href="Ledger.Chain.html#1174" class="Generalizable">e</a>
      <a id="2384" href="Ledger.Chain.html#2384" class="Bound">refunds</a>   <a id="2394" class="Symbol">=</a> <a id="2396" href="Ledger.Chain.html#2213" class="Bound">govActionReturns</a> <a id="2413" href="Axiom.Set.Map.Dec.html#1841" class="Function Operator">∪⁺</a> <a id="2416" href="Ledger.Chain.html#1933" class="Bound">trWithdrawals</a> <a id="2430" href="Axiom.Set.Map.html#8760" class="Function Operator">∣</a> <a id="2432" href="Interface.IsSet.html#794" class="Function">dom</a> <a id="2436" href="Ledger.Deleg.html#1036" class="Function">rewards</a>
      <a id="2450" href="Ledger.Chain.html#2450" class="Bound">unclaimed</a> <a id="2460" class="Symbol">=</a> <a id="2462" href="Ledger.Chain.html#2213" class="Bound">govActionReturns</a> <a id="2479" href="Axiom.Set.Map.Dec.html#1841" class="Function Operator">∪⁺</a> <a id="2482" href="Ledger.Chain.html#1933" class="Bound">trWithdrawals</a> <a id="2496" href="Axiom.Set.Map.html#8830" class="Function Operator">∣</a> <a id="2498" href="Interface.IsSet.html#794" class="Function">dom</a> <a id="2502" href="Ledger.Deleg.html#1036" class="Function">rewards</a> <a id="2510" href="Axiom.Set.Map.html#8830" class="Function Operator">ᶜ</a>

      <a id="2519" href="Ledger.Chain.html#2519" class="Bound">govSt&#39;</a> <a id="2526" class="Symbol">=</a> <a id="2528" href="Data.List.Base.html#11403" class="Function">filter</a> <a id="2535" class="Symbol">(λ</a> <a id="2538" href="Ledger.Chain.html#2538" class="Bound">x</a> <a id="2540" class="Symbol">→</a> <a id="2542" href="Interface.Decidable.Instance.html#739" class="Function Operator">¿</a> <a id="2544" href="Data.Product.Base.html#608" class="Field">proj₁</a> <a id="2550" href="Ledger.Chain.html#2538" class="Bound">x</a> <a id="2552" href="Interface.IsSet.html#497" class="Function Operator">∉</a> <a id="2554" href="Ledger.Prelude.html#1544" class="Function">mapˢ</a> <a id="2559" href="Data.Product.Base.html#608" class="Field">proj₁</a> <a id="2565" href="Ledger.Ratify.html#4968" class="Function">removed</a> <a id="2573" href="Interface.Decidable.Instance.html#739" class="Function Operator">¿</a><a id="2574" class="Symbol">)</a> <a id="2576" href="Ledger.Ledger.html#797" class="Function">govSt</a>

      <a id="2589" href="Ledger.Chain.html#2589" class="Bound">gState&#39;</a> <a id="2597" class="Symbol">=</a> <a id="2599" class="Keyword">record</a> <a id="2606" href="Ledger.Deleg.html#1445" class="Function">gState</a> <a id="2613" class="Symbol">{</a> <a id="2615" href="Ledger.Deleg.html#1293" class="Field">ccHotKeys</a> <a id="2625" class="Symbol">=</a> <a id="2627" href="Ledger.Deleg.html#1293" class="Function">ccHotKeys</a> <a id="2637" href="Axiom.Set.Map.html#8760" class="Function Operator">∣</a> <a id="2639" href="Ledger.GovernanceActions.html#12237" class="Function">ccCreds</a> <a id="2647" class="Symbol">(</a><a id="2648" href="Ledger.Chain.html#2302" class="Bound">es</a> <a id="2651" class="Symbol">.</a><a id="2652" href="Ledger.GovernanceActions.html#11975" class="Field">EnactState.cc</a><a id="2665" class="Symbol">)</a> <a id="2667" class="Symbol">}</a>

      <a id="2676" href="Ledger.Chain.html#2676" class="Bound">certState&#39;</a> <a id="2687" class="Symbol">=</a> <a id="2689" class="Keyword">record</a> <a id="2696" href="Ledger.Ledger.html#827" class="Function">certState</a> <a id="2706" class="Symbol">{</a>
        <a id="2716" href="Ledger.Deleg.html#1421" class="Field">pState</a> <a id="2723" class="Symbol">=</a> <a id="2725" class="Keyword">record</a> <a id="2732" href="Ledger.Deleg.html#1421" class="Function">pState</a>
          <a id="2749" class="Symbol">{</a> <a id="2751" href="Ledger.Deleg.html#1122" class="Field">pools</a> <a id="2757" class="Symbol">=</a> <a id="2759" href="Ledger.Deleg.html#1122" class="Function">pools</a> <a id="2765" href="Axiom.Set.Map.html#8830" class="Function Operator">∣</a> <a id="2767" href="Ledger.Chain.html#2352" class="Bound">retired</a> <a id="2775" href="Axiom.Set.Map.html#8830" class="Function Operator">ᶜ</a> <a id="2777" class="Symbol">;</a> <a id="2779" href="Ledger.Deleg.html#1166" class="Field">retiring</a> <a id="2788" class="Symbol">=</a> <a id="2790" href="Ledger.Deleg.html#1166" class="Function">retiring</a> <a id="2799" href="Axiom.Set.Map.html#8830" class="Function Operator">∣</a> <a id="2801" href="Ledger.Chain.html#2352" class="Bound">retired</a> <a id="2809" href="Axiom.Set.Map.html#8830" class="Function Operator">ᶜ</a> <a id="2811" class="Symbol">};</a>
        <a id="2822" href="Ledger.Deleg.html#1397" class="Field">dState</a> <a id="2829" class="Symbol">=</a> <a id="2831" class="Keyword">record</a> <a id="2838" href="Ledger.Deleg.html#1397" class="Function">dState</a>
          <a id="2855" class="Symbol">{</a> <a id="2857" href="Ledger.Deleg.html#1036" class="Field">rewards</a> <a id="2865" class="Symbol">=</a> <a id="2867" href="Ledger.Deleg.html#1036" class="Function">rewards</a> <a id="2875" href="Axiom.Set.Map.Dec.html#1841" class="Function Operator">∪⁺</a> <a id="2878" href="Ledger.Chain.html#2384" class="Bound">refunds</a> <a id="2886" class="Symbol">};</a>
        <a id="2897" href="Ledger.Deleg.html#1445" class="Field">gState</a> <a id="2904" class="Symbol">=</a> <a id="2906" href="Data.Bool.Base.html#1283" class="Function Operator">if</a> <a id="2909" href="Data.Bool.Base.html#932" class="Function">not</a> <a id="2913" class="Symbol">(</a><a id="2914" href="Data.List.Base.html#4717" class="Function">null</a> <a id="2919" href="Ledger.Chain.html#2519" class="Bound">govSt&#39;</a><a id="2925" class="Symbol">)</a> <a id="2927" href="Data.Bool.Base.html#1283" class="Function Operator">then</a> <a id="2932" href="Ledger.Chain.html#2589" class="Bound">gState&#39;</a> <a id="2940" href="Data.Bool.Base.html#1283" class="Function Operator">else</a> <a id="2945" class="Keyword">record</a> <a id="2952" href="Ledger.Chain.html#2589" class="Bound">gState&#39;</a>
          <a id="2970" class="Symbol">{</a> <a id="2972" href="Ledger.Deleg.html#1253" class="Field">dreps</a> <a id="2978" class="Symbol">=</a> <a id="2980" href="Axiom.Set.Map.html#6827" class="Function">mapValues</a> <a id="2990" href="Ledger.Epoch.html#782" class="Function">sucᵉ</a> <a id="2995" href="Ledger.Deleg.html#1253" class="Function">dreps</a> <a id="3001" class="Symbol">}</a>
        <a id="3011" class="Symbol">}</a>
      <a id="3019" href="Ledger.Chain.html#3019" class="Bound">utxoSt&#39;</a> <a id="3027" class="Symbol">=</a> <a id="3029" class="Keyword">record</a> <a id="3036" href="Ledger.Ledger.html#766" class="Function">utxoSt</a>
        <a id="3051" class="Symbol">{</a> <a id="3053" href="Ledger.Utxo.html#4467" class="Field">fees</a> <a id="3058" class="Symbol">=</a> <a id="3060" class="Number">0</a>
        <a id="3070" class="Symbol">;</a> <a id="3072" href="Ledger.Utxo.html#4493" class="Field">deposits</a> <a id="3081" class="Symbol">=</a> <a id="3083" href="Ledger.Utxo.html#4493" class="Function">deposits</a> <a id="3092" href="Axiom.Set.Map.html#8830" class="Function Operator">∣</a> <a id="3094" href="Ledger.Prelude.html#1544" class="Function">mapˢ</a> <a id="3099" class="Symbol">(</a><a id="3100" href="Data.Product.Base.html#608" class="Field">proj₁</a> <a id="3106" href="Function.Base.html#1106" class="Function Operator">∘</a> <a id="3108" href="Data.Product.Base.html#622" class="Field">proj₂</a><a id="3113" class="Symbol">)</a> <a id="3115" href="Ledger.Chain.html#2040" class="Bound">removedGovActions</a> <a id="3133" href="Axiom.Set.Map.html#8830" class="Function Operator">ᶜ</a>
        <a id="3143" class="Symbol">;</a> <a id="3145" href="Ledger.Utxo.html#4523" class="Field">donations</a> <a id="3155" class="Symbol">=</a> <a id="3157" class="Number">0</a>
        <a id="3167" class="Symbol">}</a>
      <a id="3175" href="Ledger.Chain.html#3175" class="Bound">ls&#39;</a> <a id="3179" class="Symbol">=</a> <a id="3181" class="Keyword">record</a> <a id="3188" href="Ledger.Chain.html#751" class="Function">ls</a>
        <a id="3199" class="Symbol">{</a> <a id="3201" href="Ledger.Ledger.html#797" class="Field">govSt</a> <a id="3207" class="Symbol">=</a> <a id="3209" href="Ledger.Chain.html#2519" class="Bound">govSt&#39;</a> <a id="3216" class="Symbol">;</a> <a id="3218" href="Ledger.Ledger.html#766" class="Field">utxoSt</a> <a id="3225" class="Symbol">=</a> <a id="3227" href="Ledger.Chain.html#3019" class="Bound">utxoSt&#39;</a> <a id="3235" class="Symbol">;</a> <a id="3237" href="Ledger.Ledger.html#827" class="Field">certState</a> <a id="3247" class="Symbol">=</a> <a id="3249" href="Ledger.Chain.html#2676" class="Bound">certState&#39;</a> <a id="3260" class="Symbol">}</a>
      <a id="3268" href="Ledger.Chain.html#3268" class="Bound">acnt&#39;</a> <a id="3274" class="Symbol">=</a> <a id="3276" class="Keyword">record</a> <a id="3283" href="Ledger.Chain.html#725" class="Function">acnt</a>
        <a id="3296" class="Symbol">{</a> <a id="3298" href="Ledger.PParams.html#741" class="Field">treasury</a> <a id="3307" class="Symbol">=</a> <a id="3309" href="Ledger.PParams.html#741" class="Function">treasury</a> <a id="3318" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="3320" href="Ledger.Utxo.html#4467" class="Function">fees</a> <a id="3325" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="3327" href="Ledger.Interface.HasCoin.html#170" class="Field">getCoin</a> <a id="3335" href="Ledger.Chain.html#2450" class="Bound">unclaimed</a> <a id="3345" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="3347" href="Ledger.Utxo.html#4523" class="Function">donations</a> <a id="3357" href="Data.Nat.Base.html#3202" class="Primitive Operator">∸</a> <a id="3359" href="Ledger.Chain.html#1985" class="Bound">totWithdrawals</a> <a id="3374" class="Symbol">}</a>
    <a id="3380" class="Keyword">in</a>
    <a id="3387" href="Ledger.Chain.html#1174" class="Generalizable">e</a> <a id="3389" href="Agda.Builtin.Equality.html#133" class="Datatype Operator">≡</a> <a id="3391" href="Ledger.Epoch.html#782" class="Function">sucᵉ</a> <a id="3396" href="Ledger.Chain.html#698" class="Function">lastEpoch</a>
    <a id="3410" class="Symbol">→</a> <a id="3412" class="Keyword">record</a> <a id="3419" class="Symbol">{</a> <a id="3421" href="Ledger.Ratify.html#4720" class="Field">currentEpoch</a> <a id="3434" class="Symbol">=</a> <a id="3436" href="Ledger.Chain.html#1174" class="Generalizable">e</a> <a id="3438" class="Symbol">;</a> <a id="3440" href="Ledger.Ratify.html#4847" class="Field">treasury</a> <a id="3449" class="Symbol">=</a> <a id="3451" href="Ledger.PParams.html#741" class="Function">treasury</a> <a id="3460" class="Symbol">;</a> <a id="3462" href="Ledger.Chain.html#3462" class="Module">GState</a> <a id="3469" href="Ledger.Deleg.html#1445" class="Function">gState</a> <a id="3476" class="Symbol">;</a> <a id="3478" href="Ledger.Chain.html#3478" class="Module">NewEpochEnv</a> <a id="3490" href="Ledger.Chain.html#1593" class="Bound">Γ</a> <a id="3492" class="Symbol">}</a>
        <a id="3502" href="Ledger.Ratify.html#20776" class="Function Operator">⊢</a> <a id="3504" href="Ledger.Ratify.html#4914" class="InductiveConstructor Operator">⟦</a> <a id="3506" href="Ledger.Chain.html#2302" class="Bound">es</a> <a id="3509" href="Ledger.Ratify.html#4914" class="InductiveConstructor Operator">,</a> <a id="3511" href="Axiom.Set.html#5746" class="Function">∅</a> <a id="3513" href="Ledger.Ratify.html#4914" class="InductiveConstructor Operator">,</a> <a id="3515" href="Agda.Builtin.Bool.html#175" class="InductiveConstructor">false</a> <a id="3521" href="Ledger.Ratify.html#4914" class="InductiveConstructor Operator">⟧ʳ</a> <a id="3524" href="Ledger.Ratify.html#20776" class="Function Operator">⇀⦇</a> <a id="3527" href="Ledger.Chain.html#2519" class="Bound">govSt&#39;</a> <a id="3534" href="Ledger.Ratify.html#20776" class="Function Operator">,RATIFY⦈</a> <a id="3543" href="Ledger.Chain.html#1236" class="Generalizable">fut&#39;</a>
    <a id="3552" href="Interface.STS.html#244" class="Function Operator">────────────────────────────────</a>
    <a id="3589" href="Ledger.Chain.html#1593" class="Bound">Γ</a> <a id="3591" href="Ledger.Chain.html#1446" class="Datatype Operator">⊢</a> <a id="3593" href="Ledger.Chain.html#1152" class="Generalizable">nes</a> <a id="3597" href="Ledger.Chain.html#1446" class="Datatype Operator">⇀⦇</a> <a id="3600" href="Ledger.Chain.html#1174" class="Generalizable">e</a> <a id="3602" href="Ledger.Chain.html#1446" class="Datatype Operator">,NEWEPOCH⦈</a> <a id="3613" href="Ledger.Chain.html#676" class="InductiveConstructor Operator">⟦</a> <a id="3615" href="Ledger.Chain.html#1174" class="Generalizable">e</a> <a id="3617" href="Ledger.Chain.html#676" class="InductiveConstructor Operator">,</a> <a id="3619" href="Ledger.Chain.html#3268" class="Bound">acnt&#39;</a> <a id="3625" href="Ledger.Chain.html#676" class="InductiveConstructor Operator">,</a> <a id="3627" href="Ledger.Chain.html#3175" class="Bound">ls&#39;</a> <a id="3631" href="Ledger.Chain.html#676" class="InductiveConstructor Operator">,</a> <a id="3633" href="Ledger.Chain.html#2302" class="Bound">es</a> <a id="3636" href="Ledger.Chain.html#676" class="InductiveConstructor Operator">,</a> <a id="3638" href="Ledger.Chain.html#1236" class="Generalizable">fut&#39;</a> <a id="3643" href="Ledger.Chain.html#676" class="InductiveConstructor Operator">⟧ⁿᵉ</a>

  <a id="_⊢_⇀⦇_,NEWEPOCH⦈_.NEWEPOCH-Not-New"></a><a id="3650" href="Ledger.Chain.html#3650" class="InductiveConstructor">NEWEPOCH-Not-New</a> <a id="3667" class="Symbol">:</a> <a id="3669" class="Symbol">∀</a> <a id="3671" class="Symbol">{</a><a id="3672" href="Ledger.Chain.html#3672" class="Bound">Γ</a><a id="3673" class="Symbol">}</a> <a id="3675" class="Symbol">→</a> <a id="3677" class="Keyword">let</a> <a id="3681" class="Keyword">open</a> <a id="3686" href="Ledger.Chain.html#636" class="Module">NewEpochState</a> <a id="3700" href="Ledger.Chain.html#1152" class="Generalizable">nes</a> <a id="3704" class="Keyword">in</a>
    <a id="3711" href="Ledger.Chain.html#1174" class="Generalizable">e</a> <a id="3713" href="Relation.Binary.PropositionalEquality.Core.html#844" class="Function Operator">≢</a> <a id="3715" href="Ledger.Epoch.html#782" class="Function">sucᵉ</a> <a id="3720" href="Ledger.Chain.html#698" class="Function">lastEpoch</a>
    <a id="3734" href="Interface.STS.html#244" class="Function Operator">────────────────────────────────</a>
    <a id="3771" href="Ledger.Chain.html#3672" class="Bound">Γ</a> <a id="3773" href="Ledger.Chain.html#1446" class="Datatype Operator">⊢</a> <a id="3775" href="Ledger.Chain.html#1152" class="Generalizable">nes</a> <a id="3779" href="Ledger.Chain.html#1446" class="Datatype Operator">⇀⦇</a> <a id="3782" href="Ledger.Chain.html#1174" class="Generalizable">e</a> <a id="3784" href="Ledger.Chain.html#1446" class="Datatype Operator">,NEWEPOCH⦈</a> <a id="3795" href="Ledger.Chain.html#1152" class="Generalizable">nes</a>
<a id="3799" class="Markup">\end{code}</a><a id="3809" class="Background">
\caption{NEWEPOCH transition system}
\end{figure*}

</a><a id="3862" class="Markup">\begin{code}[hide]</a>
<a id="3881" class="Comment">-- TODO: do we still need this for anything?</a>
<a id="maybePurpose"></a><a id="3926" href="Ledger.Chain.html#3926" class="Function">maybePurpose</a> <a id="3939" class="Symbol">:</a> <a id="3941" href="Ledger.Utxo.html#1964" class="Datatype">DepositPurpose</a> <a id="3956" class="Symbol">→</a> <a id="3958" class="Symbol">(</a><a id="3959" href="Ledger.Utxo.html#1964" class="Datatype">DepositPurpose</a> <a id="3974" href="Data.Product.Base.html#1109" class="Function Operator">×</a> <a id="3976" href="Ledger.Address.html#713" class="Function">Credential</a><a id="3986" class="Symbol">)</a> <a id="3988" class="Symbol">→</a> <a id="3990" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="3995" class="Symbol">→</a> <a id="3997" href="Agda.Builtin.Maybe.html#118" class="Datatype">Maybe</a> <a id="4003" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="4008" href="Ledger.Chain.html#3926" class="Function">maybePurpose</a> <a id="4021" href="Ledger.Chain.html#4021" class="Bound">prps</a> <a id="4026" class="Symbol">(</a><a id="4027" href="Ledger.Chain.html#4027" class="Bound">prps&#39;</a> <a id="4033" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="4035" class="Symbol">_)</a> <a id="4038" href="Ledger.Chain.html#4038" class="Bound">c</a> <a id="4040" class="Keyword">with</a> <a id="4045" href="Ledger.Chain.html#4021" class="Bound">prps</a> <a id="4050" href="Interface.DecEq.html#243" class="Field Operator">≟</a> <a id="4052" href="Ledger.Chain.html#4027" class="Bound">prps&#39;</a>
<a id="4058" class="Symbol">...</a> <a id="4062" class="Symbol">|</a> <a id="4064" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="4068" class="Symbol">_</a> <a id="4070" class="Symbol">=</a> <a id="4072" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="4077" class="Bound">c</a>
<a id="4079" class="Symbol">...</a> <a id="4083" class="Symbol">|</a> <a id="4085" href="Relation.Nullary.Decidable.Core.html#1650" class="InductiveConstructor">no</a> <a id="4088" class="Symbol">_</a> <a id="4090" class="Symbol">=</a> <a id="4092" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a>

<a id="maybePurpose-prop"></a><a id="4101" href="Ledger.Chain.html#4101" class="Function">maybePurpose-prop</a> <a id="4119" class="Symbol">:</a> <a id="4121" class="Symbol">∀</a> <a id="4123" class="Symbol">{</a><a id="4124" href="Ledger.Chain.html#4124" class="Bound">prps</a><a id="4128" class="Symbol">}</a> <a id="4130" class="Symbol">{</a><a id="4131" href="Ledger.Chain.html#4131" class="Bound">x</a><a id="4132" class="Symbol">}</a> <a id="4134" class="Symbol">{</a><a id="4135" href="Ledger.Chain.html#4135" class="Bound">y</a><a id="4136" class="Symbol">}</a>
  <a id="4140" class="Symbol">→</a> <a id="4142" class="Symbol">(</a><a id="4143" href="Ledger.Chain.html#4143" class="Bound">m</a> <a id="4145" class="Symbol">:</a> <a id="4147" class="Symbol">(</a><a id="4148" href="Ledger.Utxo.html#1964" class="Datatype">DepositPurpose</a> <a id="4163" href="Data.Product.Base.html#1109" class="Function Operator">×</a> <a id="4165" href="Ledger.Address.html#713" class="Function">Credential</a><a id="4175" class="Symbol">)</a> <a id="4177" href="Ledger.Prelude.html#2629" class="Function Operator">⇀</a> <a id="4179" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a><a id="4183" class="Symbol">)</a>
  <a id="4187" class="Symbol">→</a> <a id="4189" class="Symbol">(</a><a id="4190" href="Ledger.Chain.html#4131" class="Bound">x</a> <a id="4192" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="4194" href="Ledger.Chain.html#4135" class="Bound">y</a><a id="4195" class="Symbol">)</a> <a id="4197" href="Interface.IsSet.html#493" class="Function Operator">∈</a> <a id="4199" href="Interface.IsSet.html#794" class="Function">dom</a> <a id="4203" class="Symbol">((</a><a id="4205" href="Axiom.Set.Map.html#8509" class="Function">mapMaybeWithKeyᵐ</a> <a id="4222" class="Symbol">(</a><a id="4223" href="Ledger.Chain.html#3926" class="Function">maybePurpose</a> <a id="4236" href="Ledger.Chain.html#4124" class="Bound">prps</a><a id="4240" class="Symbol">)</a> <a id="4242" href="Ledger.Chain.html#4143" class="Bound">m</a><a id="4243" class="Symbol">)</a> <a id="4245" href="Axiom.Set.Map.html#2295" class="Function Operator">ˢ</a><a id="4246" class="Symbol">)</a>
  <a id="4250" class="Symbol">→</a> <a id="4252" href="Ledger.Chain.html#4131" class="Bound">x</a> <a id="4254" href="Agda.Builtin.Equality.html#133" class="Datatype Operator">≡</a> <a id="4256" href="Ledger.Chain.html#4124" class="Bound">prps</a>
<a id="4261" href="Ledger.Chain.html#4101" class="Function">maybePurpose-prop</a> <a id="4279" class="Symbol">{</a><a id="4280" class="Argument">prps</a> <a id="4285" class="Symbol">=</a> <a id="4287" href="Ledger.Chain.html#4287" class="Bound">prps</a><a id="4291" class="Symbol">}</a> <a id="4293" class="Symbol">{</a><a id="4294" href="Ledger.Chain.html#4294" class="Bound">x</a><a id="4295" class="Symbol">}</a> <a id="4297" class="Symbol">{</a><a id="4298" href="Ledger.Chain.html#4298" class="Bound">y</a><a id="4299" class="Symbol">}</a> <a id="4301" class="Symbol">_</a> <a id="4303" href="Ledger.Chain.html#4303" class="Bound">xy∈dom</a> <a id="4310" class="Keyword">with</a> <a id="4315" href="Function.Bundles.html#4398" class="Field">to</a> <a id="4318" href="Axiom.Set.Rel.html#2496" class="Function">dom∈</a> <a id="4323" href="Ledger.Chain.html#4303" class="Bound">xy∈dom</a>
<a id="4330" class="Symbol">...</a> <a id="4334" class="Symbol">|</a> <a id="4336" href="Ledger.Chain.html#4336" class="Bound">z</a> <a id="4338" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="4340" href="Ledger.Chain.html#4340" class="Bound">∈mmwk</a> <a id="4346" class="Keyword">with</a> <a id="4351" class="Bound">prps</a> <a id="4356" href="Interface.DecEq.html#243" class="Field Operator">≟</a> <a id="4358" class="Bound">x</a> <a id="4360" class="Symbol">|</a> <a id="4362" href="Axiom.Set.Rel.html#3995" class="Function">∈-mapMaybeWithKey</a> <a id="4380" class="Symbol">{</a><a id="4381" class="Argument">f</a> <a id="4383" class="Symbol">=</a> <a id="4385" href="Ledger.Chain.html#3926" class="Function">maybePurpose</a> <a id="4398" class="Bound">prps</a><a id="4402" class="Symbol">}</a> <a id="4404" href="Ledger.Chain.html#4340" class="Bound">∈mmwk</a>
<a id="4410" class="Symbol">...</a> <a id="4414" class="Symbol">|</a> <a id="4416" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="4420" href="Agda.Builtin.Equality.html#190" class="InductiveConstructor">refl</a> <a id="4425" class="Symbol">|</a> <a id="4427" class="Symbol">_</a> <a id="4429" class="Symbol">=</a> <a id="4431" href="Agda.Builtin.Equality.html#190" class="InductiveConstructor">refl</a>

<a id="filterPurpose"></a><a id="4437" href="Ledger.Chain.html#4437" class="Function">filterPurpose</a> <a id="4451" class="Symbol">:</a> <a id="4453" href="Ledger.Utxo.html#1964" class="Datatype">DepositPurpose</a> <a id="4468" class="Symbol">→</a> <a id="4470" class="Symbol">(</a><a id="4471" href="Ledger.Utxo.html#1964" class="Datatype">DepositPurpose</a> <a id="4486" href="Data.Product.Base.html#1109" class="Function Operator">×</a> <a id="4488" href="Ledger.Address.html#713" class="Function">Credential</a><a id="4498" class="Symbol">)</a> <a id="4500" href="Ledger.Prelude.html#2629" class="Function Operator">⇀</a> <a id="4502" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="4507" class="Symbol">→</a> <a id="4509" href="Ledger.Address.html#713" class="Function">Credential</a> <a id="4520" href="Ledger.Prelude.html#2629" class="Function Operator">⇀</a> <a id="4522" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="4527" href="Ledger.Chain.html#4437" class="Function">filterPurpose</a> <a id="4541" href="Ledger.Chain.html#4541" class="Bound">prps</a> <a id="4546" href="Ledger.Chain.html#4546" class="Bound">m</a> <a id="4548" class="Symbol">=</a> <a id="4550" href="Axiom.Set.Map.html#6655" class="Function">mapKeys</a> <a id="4558" href="Data.Product.Base.html#622" class="Field">proj₂</a> <a id="4564" class="Symbol">(</a><a id="4565" href="Axiom.Set.Map.html#8509" class="Function">mapMaybeWithKeyᵐ</a> <a id="4582" class="Symbol">(</a><a id="4583" href="Ledger.Chain.html#3926" class="Function">maybePurpose</a> <a id="4596" href="Ledger.Chain.html#4541" class="Bound">prps</a><a id="4600" class="Symbol">)</a> <a id="4602" href="Ledger.Chain.html#4546" class="Bound">m</a><a id="4603" class="Symbol">)</a>
  <a id="4607" class="Symbol">{λ</a> <a id="4610" class="Keyword">where</a> <a id="4616" href="Ledger.Chain.html#4616" class="Bound">x∈dom</a> <a id="4622" href="Ledger.Chain.html#4622" class="Bound">y∈dom</a> <a id="4628" href="Agda.Builtin.Equality.html#190" class="InductiveConstructor">refl</a> <a id="4633" class="Symbol">→</a> <a id="4635" href="Relation.Binary.PropositionalEquality.Core.html#1144" class="Function">cong</a> <a id="4640" class="Symbol">(</a><a id="4641" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">_,</a> <a id="4644" class="Symbol">_)</a>
                            <a id="4675" href="Function.Base.html#1994" class="Function Operator">$</a> <a id="4677" href="Relation.Binary.PropositionalEquality.Core.html#1743" class="Function">trans</a> <a id="4683" class="Symbol">(</a><a id="4684" href="Ledger.Chain.html#4101" class="Function">maybePurpose-prop</a> <a id="4702" class="Symbol">{</a><a id="4703" class="Argument">prps</a> <a id="4708" class="Symbol">=</a> <a id="4710" href="Ledger.Chain.html#4541" class="Bound">prps</a><a id="4714" class="Symbol">}</a> <a id="4716" href="Ledger.Chain.html#4546" class="Bound">m</a> <a id="4718" href="Ledger.Chain.html#4616" class="Bound">x∈dom</a><a id="4723" class="Symbol">)</a>
                            <a id="4753" href="Function.Base.html#1994" class="Function Operator">$</a> <a id="4755" href="Relation.Binary.PropositionalEquality.Core.html#1698" class="Function">sym</a>   <a id="4761" class="Symbol">(</a><a id="4762" href="Ledger.Chain.html#4101" class="Function">maybePurpose-prop</a> <a id="4780" class="Symbol">{</a><a id="4781" class="Argument">prps</a> <a id="4786" class="Symbol">=</a> <a id="4788" href="Ledger.Chain.html#4541" class="Bound">prps</a><a id="4792" class="Symbol">}</a> <a id="4794" href="Ledger.Chain.html#4546" class="Bound">m</a> <a id="4796" href="Ledger.Chain.html#4622" class="Bound">y∈dom</a><a id="4801" class="Symbol">)}</a>

<a id="govActionDeposits"></a><a id="4805" href="Ledger.Chain.html#4805" class="Function">govActionDeposits</a> <a id="4823" class="Symbol">:</a> <a id="4825" href="Ledger.Ledger.html#716" class="Record">LState</a> <a id="4832" class="Symbol">→</a> <a id="4834" href="Ledger.GovernanceActions.html#1054" class="Datatype">VDeleg</a> <a id="4841" href="Ledger.Prelude.html#2629" class="Function Operator">⇀</a> <a id="4843" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="4848" href="Ledger.Chain.html#4805" class="Function">govActionDeposits</a> <a id="4866" href="Ledger.Chain.html#4866" class="Bound">ls</a> <a id="4869" class="Symbol">=</a>
  <a id="4873" class="Keyword">let</a> <a id="4877" class="Keyword">open</a> <a id="4882" href="Ledger.Ledger.html#716" class="Module">LState</a> <a id="4889" href="Ledger.Chain.html#4866" class="Bound">ls</a><a id="4891" class="Symbol">;</a> <a id="4893" class="Keyword">open</a> <a id="4898" href="Ledger.Deleg.html#1344" class="Module">CertState</a> <a id="4908" href="Ledger.Ledger.html#827" class="Field">certState</a><a id="4917" class="Symbol">;</a> <a id="4919" class="Keyword">open</a> <a id="4924" href="Ledger.Deleg.html#1074" class="Module">PState</a> <a id="4931" href="Ledger.Deleg.html#1421" class="Function">pState</a>
      <a id="4944" class="Keyword">open</a> <a id="4949" href="Ledger.Utxo.html#4386" class="Module">UTxOState</a> <a id="4959" href="Ledger.Ledger.html#766" class="Field">utxoSt</a><a id="4965" class="Symbol">;</a> <a id="4967" class="Keyword">open</a> <a id="4972" href="Ledger.Deleg.html#816" class="Module">DState</a> <a id="4979" href="Ledger.Deleg.html#1397" class="Function">dState</a>
   <a id="4989" class="Keyword">in</a> <a id="4992" href="Data.List.Base.html#4412" class="Function">foldl</a> <a id="4998" href="Axiom.Set.Map.Dec.html#1841" class="Function Operator">_∪⁺_</a> <a id="5003" href="Axiom.Set.Map.html#2741" class="Function">∅ᵐ</a> <a id="5006" href="Function.Base.html#1994" class="Function Operator">$</a> <a id="5008" href="Ledger.Prelude.html#2351" class="Function">setToList</a> <a id="5018" href="Function.Base.html#1994" class="Function Operator">$</a>
    <a id="5024" href="Axiom.Set.html#7573" class="Function">mapPartial</a>
      <a id="5041" class="Symbol">(λ</a> <a id="5044" class="Keyword">where</a> <a id="5050" class="Symbol">(</a><a id="5051" href="Ledger.Chain.html#5051" class="Bound">gaid</a> <a id="5056" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="5058" class="Keyword">record</a> <a id="5065" class="Symbol">{</a> <a id="5067" href="Ledger.Gov.html#777" class="Field">returnAddr</a> <a id="5078" class="Symbol">=</a> <a id="5080" class="Keyword">record</a> <a id="5087" class="Symbol">{</a><a id="5088" href="Ledger.Address.html#1269" class="Field">stake</a> <a id="5094" class="Symbol">=</a> <a id="5096" href="Ledger.Chain.html#5096" class="Bound">c</a><a id="5097" class="Symbol">}</a> <a id="5099" class="Symbol">})</a> <a id="5102" class="Symbol">→</a> <a id="5104" class="Keyword">do</a>
        <a id="5115" href="Ledger.Chain.html#5115" class="Bound">vd</a> <a id="5118" href="Data.Maybe.Base.html#2242" class="Function Operator">←</a> <a id="5120" href="Axiom.Set.Map.html#10514" class="Function">lookupᵐ?</a> <a id="5129" href="Ledger.Deleg.html#870" class="Function">voteDelegs</a> <a id="5140" href="Ledger.Chain.html#5096" class="Bound">c</a> <a id="5142" class="Symbol">⦃</a> <a id="5144" class="Symbol">_</a> <a id="5146" href="Axiom.Set.html#10312" class="Function Operator">∈?</a> <a id="5149" class="Symbol">_</a> <a id="5151" class="Symbol">⦄</a>
        <a id="5161" href="Ledger.Chain.html#5161" class="Bound">dep</a> <a id="5165" href="Data.Maybe.Base.html#2242" class="Function Operator">←</a> <a id="5167" href="Axiom.Set.Map.html#10514" class="Function">lookupᵐ?</a> <a id="5176" href="Ledger.Utxo.html#4493" class="Function">deposits</a> <a id="5185" class="Symbol">(</a><a id="5186" href="Ledger.Utxo.html#2160" class="InductiveConstructor">GovActionDeposit</a> <a id="5203" href="Ledger.Chain.html#5051" class="Bound">gaid</a><a id="5207" class="Symbol">)</a> <a id="5209" class="Symbol">⦃</a> <a id="5211" class="Symbol">_</a> <a id="5213" href="Axiom.Set.html#10312" class="Function Operator">∈?</a> <a id="5216" class="Symbol">_</a> <a id="5218" class="Symbol">⦄</a>
        <a id="5228" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="5233" href="Axiom.Set.Map.html#4558" class="Function Operator">❴</a> <a id="5235" href="Ledger.Chain.html#5115" class="Bound">vd</a> <a id="5238" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="5240" href="Ledger.Chain.html#5161" class="Bound">dep</a> <a id="5244" href="Axiom.Set.Map.html#4558" class="Function Operator">❵ᵐ</a> <a id="5247" class="Symbol">)</a>
      <a id="5255" class="Symbol">(</a><a id="5256" href="Axiom.Set.html#5489" class="Function">fromList</a> <a id="5265" href="Ledger.Ledger.html#797" class="Field">govSt</a><a id="5270" class="Symbol">)</a>

<a id="calculateStakeDistrs"></a><a id="5273" href="Ledger.Chain.html#5273" class="Function">calculateStakeDistrs</a> <a id="5294" class="Symbol">:</a> <a id="5296" href="Ledger.Ledger.html#716" class="Record">LState</a> <a id="5303" class="Symbol">→</a> <a id="5305" href="Ledger.Ratify.html#4586" class="Record">StakeDistrs</a>
<a id="5317" href="Ledger.Chain.html#5273" class="Function">calculateStakeDistrs</a> <a id="5338" href="Ledger.Chain.html#5338" class="Bound">ls</a> <a id="5341" class="Symbol">=</a>
  <a id="5345" class="Keyword">let</a> <a id="5349" class="Keyword">open</a> <a id="5354" href="Ledger.Ledger.html#716" class="Module">LState</a> <a id="5361" href="Ledger.Chain.html#5338" class="Bound">ls</a><a id="5363" class="Symbol">;</a> <a id="5365" class="Keyword">open</a> <a id="5370" href="Ledger.Deleg.html#1344" class="Module">CertState</a> <a id="5380" href="Ledger.Ledger.html#827" class="Field">certState</a><a id="5389" class="Symbol">;</a> <a id="5391" class="Keyword">open</a> <a id="5396" href="Ledger.Deleg.html#1074" class="Module">PState</a> <a id="5403" href="Ledger.Deleg.html#1421" class="Function">pState</a>
      <a id="5416" class="Keyword">open</a> <a id="5421" href="Ledger.Utxo.html#4386" class="Module">UTxOState</a> <a id="5431" href="Ledger.Ledger.html#766" class="Field">utxoSt</a><a id="5437" class="Symbol">;</a> <a id="5439" class="Keyword">open</a> <a id="5444" href="Ledger.Deleg.html#816" class="Module">DState</a> <a id="5451" href="Ledger.Deleg.html#1397" class="Function">dState</a>
      <a id="5464" href="Ledger.Chain.html#5464" class="Bound">spoDelegs</a> <a id="5474" class="Symbol">=</a> <a id="5476" href="Axiom.Set.Map.html#2741" class="Function">∅ᵐ</a> <a id="5479" class="Comment">-- TODO</a>
      <a id="5493" href="Ledger.Chain.html#5493" class="Bound">drepDelegs</a> <a id="5504" class="Symbol">=</a> <a id="5506" href="Axiom.Set.Map.html#2741" class="Function">∅ᵐ</a> <a id="5509" class="Comment">-- TODO</a>
  <a id="5519" class="Keyword">in</a>
  <a id="5524" class="Keyword">record</a>
    <a id="5535" class="Symbol">{</a> <a id="5537" href="Ledger.Ratify.html#4618" class="Field">stakeDistr</a> <a id="5548" class="Symbol">=</a> <a id="5550" href="Ledger.Chain.html#4805" class="Function">govActionDeposits</a> <a id="5568" href="Ledger.Chain.html#5338" class="Bound">ls</a>
    <a id="5575" class="Symbol">}</a>


<a id="5579" class="Keyword">data</a>
<a id="5584" class="Markup">\end{code}</a><a id="5594" class="Background">
\begin{figure*}[h]
</a><a id="5614" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,CHAIN⦈_"></a><a id="5629" href="Ledger.Chain.html#5629" class="Datatype Operator">_⊢_⇀⦇_,CHAIN⦈_</a> <a id="5644" class="Symbol">:</a> <a id="5646" href="Agda.Builtin.Unit.html#158" class="Record">⊤</a> <a id="5648" class="Symbol">→</a> <a id="5650" href="Ledger.Chain.html#844" class="Record">ChainState</a> <a id="5661" class="Symbol">→</a> <a id="5663" href="Ledger.Chain.html#914" class="Record">Block</a> <a id="5669" class="Symbol">→</a> <a id="5671" href="Ledger.Chain.html#844" class="Record">ChainState</a> <a id="5682" class="Symbol">→</a> <a id="5684" href="Agda.Primitive.html#320" class="Primitive">Set</a>
<a id="5688" class="Markup">\end{code}</a><a id="5698" class="Background">
\caption{Type of the CHAIN transition system}
\end{figure*}
</a><a id="5759" class="Markup">\begin{code}[hide]</a>
  <a id="5780" class="Keyword">where</a>
<a id="5786" class="Markup">\end{code}</a><a id="5796" class="Background">
\begin{figure*}[h]
</a><a id="5816" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,CHAIN⦈_.CHAIN"></a><a id="5831" href="Ledger.Chain.html#5831" class="InductiveConstructor">CHAIN</a> <a id="5837" class="Symbol">:</a>
    <a id="5843" class="Keyword">let</a> <a id="5847" class="Keyword">open</a> <a id="5852" href="Ledger.Chain.html#844" class="Module">ChainState</a> <a id="5863" href="Ledger.Chain.html#1108" class="Generalizable">s</a><a id="5864" class="Symbol">;</a> <a id="5866" class="Keyword">open</a> <a id="5871" href="Ledger.Chain.html#914" class="Module">Block</a> <a id="5877" href="Ledger.Chain.html#1125" class="Generalizable">b</a><a id="5878" class="Symbol">;</a> <a id="5880" class="Keyword">open</a> <a id="5885" href="Ledger.Chain.html#636" class="Module">NewEpochState</a> <a id="5899" href="Ledger.Chain.html#1152" class="Generalizable">nes</a><a id="5902" class="Symbol">;</a> <a id="5904" class="Keyword">open</a> <a id="5909" href="Ledger.GovernanceActions.html#11944" class="Module">EnactState</a> <a id="5920" href="Ledger.Chain.html#779" class="Function">es</a> <a id="5923" class="Keyword">in</a>
       <a id="5933" class="Keyword">record</a> <a id="5940" class="Symbol">{</a> <a id="5942" href="Ledger.Chain.html#557" class="Field">stakeDistrs</a> <a id="5954" class="Symbol">=</a> <a id="5956" href="Ledger.Chain.html#5273" class="Function">calculateStakeDistrs</a> <a id="5977" href="Ledger.Chain.html#751" class="Function">ls</a> <a id="5980" class="Symbol">}</a>
         <a id="5991" href="Ledger.Chain.html#1446" class="Datatype Operator">⊢</a> <a id="5993" href="Ledger.Chain.html#875" class="Function">newEpochState</a> <a id="6007" href="Ledger.Chain.html#1446" class="Datatype Operator">⇀⦇</a> <a id="6010" href="Ledger.Epoch.html#587" class="Function">epoch</a> <a id="6016" href="Ledger.Chain.html#964" class="Function">slot</a> <a id="6021" href="Ledger.Chain.html#1446" class="Datatype Operator">,NEWEPOCH⦈</a> <a id="6032" href="Ledger.Chain.html#1152" class="Generalizable">nes</a>
    <a id="6040" class="Symbol">→</a>  <a id="6043" href="Ledger.Ledger.html#611" class="InductiveConstructor Operator">⟦</a> <a id="6045" href="Ledger.Chain.html#964" class="Function">slot</a> <a id="6050" href="Ledger.Ledger.html#611" class="InductiveConstructor Operator">,</a> <a id="6052" href="Ledger.GovernanceActions.html#12046" class="Function">constitution</a> <a id="6065" class="Symbol">.</a><a id="6066" href="Data.Product.Base.html#608" class="Field">proj₁</a> <a id="6072" class="Symbol">.</a><a id="6073" href="Data.Product.Base.html#622" class="Field">proj₂</a> <a id="6079" href="Ledger.Ledger.html#611" class="InductiveConstructor Operator">,</a> <a id="6081" href="Ledger.GovernanceActions.html#12159" class="Function">pparams</a> <a id="6089" class="Symbol">.</a><a id="6090" href="Data.Product.Base.html#608" class="Field">proj₁</a> <a id="6096" href="Ledger.Ledger.html#611" class="InductiveConstructor Operator">⟧ˡᵉ</a>
         <a id="6109" href="Ledger.Ledger.html#2080" class="Function Operator">⊢</a> <a id="6111" href="Ledger.Chain.html#751" class="Function">ls</a> <a id="6114" href="Ledger.Ledger.html#2080" class="Function Operator">⇀⦇</a> <a id="6117" href="Ledger.Chain.html#940" class="Function">ts</a> <a id="6120" href="Ledger.Ledger.html#2080" class="Function Operator">,LEDGERS⦈</a> <a id="6130" href="Ledger.Chain.html#1137" class="Generalizable">ls&#39;</a>
    <a id="6138" href="Interface.STS.html#244" class="Function Operator">────────────────────────────────</a>
    <a id="6175" class="Symbol">_</a> <a id="6177" href="Ledger.Chain.html#5629" class="Datatype Operator">⊢</a> <a id="6179" href="Ledger.Chain.html#1108" class="Generalizable">s</a> <a id="6181" href="Ledger.Chain.html#5629" class="Datatype Operator">⇀⦇</a> <a id="6184" href="Ledger.Chain.html#1125" class="Generalizable">b</a> <a id="6186" href="Ledger.Chain.html#5629" class="Datatype Operator">,CHAIN⦈</a> <a id="6194" class="Keyword">record</a> <a id="6201" href="Ledger.Chain.html#1108" class="Generalizable">s</a> <a id="6203" class="Symbol">{</a> <a id="6205" href="Ledger.Chain.html#875" class="Field">newEpochState</a> <a id="6219" class="Symbol">=</a> <a id="6221" class="Keyword">record</a> <a id="6228" href="Ledger.Chain.html#1152" class="Generalizable">nes</a> <a id="6232" class="Symbol">{</a> <a id="6234" href="Ledger.Chain.html#751" class="Field">ls</a> <a id="6237" class="Symbol">=</a> <a id="6239" href="Ledger.Chain.html#1137" class="Generalizable">ls&#39;</a> <a id="6243" class="Symbol">}</a> <a id="6245" class="Symbol">}</a>
<a id="6247" class="Markup">\end{code}</a><a id="6257" class="Background">
\caption{CHAIN transition system}
\end{figure*}
</a></pre></body></html>