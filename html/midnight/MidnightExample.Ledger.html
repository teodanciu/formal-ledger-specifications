<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>MidnightExample.Ledger</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda"><a id="1" class="Background">\section{Introduction}

</a><a id="25" class="Markup">\begin{code}[hide]</a>
<a id="44" class="Symbol">{-#</a> <a id="48" class="Keyword">OPTIONS</a> <a id="56" class="Pragma">--safe</a> <a id="63" class="Symbol">#-}</a>
<a id="67" class="Keyword">open</a> <a id="72" class="Keyword">import</a> <a id="79" href="Interface.DecEq.html" class="Module">Interface.DecEq</a>
<a id="95" class="Keyword">open</a> <a id="100" class="Keyword">import</a> <a id="107" href="Interface.Hashable.html" class="Module">Interface.Hashable</a>

<a id="127" class="Keyword">open</a> <a id="132" class="Keyword">import</a> <a id="139" href="Ledger.Prelude.html" class="Module">Ledger.Prelude</a> <a id="154" class="Symbol">as</a> <a id="157" class="Module">Prelude</a>
  <a id="167" class="Keyword">hiding</a> <a id="174" class="Symbol">(</a><a id="175" href="Data.Nat.Base.html#1301" class="Primitive Operator">_&lt;ᵇ_</a><a id="179" class="Symbol">;</a> <a id="181" href="Data.Bool.Base.html#986" class="Function Operator">_∧_</a><a id="184" class="Symbol">)</a>
  <a id="188" class="Keyword">renaming</a> <a id="197" class="Symbol">(</a><a id="198" href="Data.Product.Base.html#1109" class="Function Operator">_×_</a> <a id="202" class="Symbol">to</a> <a id="205" class="Function Operator">_∧_</a><a id="208" class="Symbol">)</a>
<a id="210" class="Keyword">open</a> <a id="215" class="Keyword">import</a> <a id="222" href="Data.Integer.html" class="Module">Data.Integer</a> <a id="235" class="Keyword">using</a> <a id="241" class="Symbol">(</a><a id="242" href="Agda.Builtin.Int.html#246" class="InductiveConstructor">+_</a><a id="244" class="Symbol">;</a> <a id="246" href="Data.Integer.Base.html#1518" class="Function">0ℤ</a><a id="248" class="Symbol">;</a> <a id="250" href="Data.Integer.Base.html#1558" class="Function">1ℤ</a><a id="252" class="Symbol">;</a> <a id="254" href="Data.Integer.Base.html#1534" class="Function">-1ℤ</a><a id="257" class="Symbol">)</a>

<a id="260" class="Keyword">module</a> <a id="267" href="MidnightExample.Ledger.html" class="Module">MidnightExample.Ledger</a>
  <a id="292" class="Symbol">(</a><a id="293" href="MidnightExample.Ledger.html#293" class="Bound">Hash</a> <a id="298" class="Symbol">:</a> <a id="300" href="Agda.Primitive.html#320" class="Primitive">Set</a><a id="303" class="Symbol">)</a>
  <a id="307" class="Symbol">⦃</a> <a id="309" href="MidnightExample.Ledger.html#309" class="Bound">_</a> <a id="311" class="Symbol">:</a> <a id="313" href="Interface.DecEq.html#185" class="Record">DecEq</a> <a id="319" href="MidnightExample.Ledger.html#293" class="Bound">Hash</a> <a id="324" class="Symbol">⦄</a>
  <a id="328" class="Symbol">⦃</a> <a id="330" href="MidnightExample.Ledger.html#330" class="Bound">_</a> <a id="332" class="Symbol">:</a> <a id="334" href="Interface.Hashable.html#64" class="Record">Hashable</a> <a id="343" href="Agda.Builtin.Int.html#228" class="Datatype">ℤ</a> <a id="345" href="MidnightExample.Ledger.html#293" class="Bound">Hash</a> <a id="350" class="Symbol">⦄</a>
  <a id="354" class="Symbol">⦃</a> <a id="356" href="MidnightExample.Ledger.html#356" class="Bound">_</a> <a id="358" class="Symbol">:</a> <a id="360" href="Interface.Hashable.html#155" class="Function">Hashable₁</a> <a id="370" href="Agda.Builtin.List.html#130" class="Datatype">List</a> <a id="375" href="MidnightExample.Ledger.html#293" class="Bound">Hash</a> <a id="380" class="Symbol">⦄</a>
  <a id="384" class="Symbol">⦃</a> <a id="386" href="MidnightExample.Ledger.html#386" class="Bound">_</a> <a id="388" class="Symbol">:</a> <a id="390" href="Interface.Hashable.html#269" class="Function">Hashable₂</a> <a id="400" href="MidnightExample.Ledger.html#205" class="Function Operator">_∧_</a> <a id="404" href="MidnightExample.Ledger.html#293" class="Bound">Hash</a> <a id="409" class="Symbol">⦄</a>
  <a id="413" class="Keyword">where</a>

<a id="420" class="Keyword">open</a> <a id="425" class="Keyword">import</a> <a id="432" href="Data.Integer.Properties.html" class="Module">Data.Integer.Properties</a> <a id="456" class="Keyword">using</a> <a id="462" class="Symbol">(</a><a id="463" href="Data.Integer.Properties.html#31484" class="Function">+-0-commutativeMonoid</a><a id="484" class="Symbol">;</a> <a id="486" href="Data.Integer.Properties.html#31618" class="Function">+-0-abelianGroup</a><a id="502" class="Symbol">)</a>
<a id="504" class="Keyword">open</a> <a id="509" class="Keyword">import</a> <a id="516" href="Relation.Nullary.html" class="Module">Relation.Nullary</a>

<a id="534" class="Keyword">instance</a>
  <a id="545" href="MidnightExample.Ledger.html#545" class="Function">_</a> <a id="547" class="Symbol">=</a> <a id="549" href="Data.Integer.Properties.html#31484" class="Function">+-0-commutativeMonoid</a>

  <a id="Hashable-ℕ"></a><a id="574" href="MidnightExample.Ledger.html#574" class="Function">Hashable-ℕ</a> <a id="585" class="Symbol">:</a> <a id="587" href="Interface.Hashable.html#64" class="Record">Hashable</a> <a id="596" href="Agda.Builtin.Nat.html#186" class="Datatype">ℕ</a> <a id="598" href="MidnightExample.Ledger.html#293" class="Bound">Hash</a>
  <a id="605" href="MidnightExample.Ledger.html#574" class="Function">Hashable-ℕ</a> <a id="616" class="Symbol">.</a><a id="617" href="Interface.Hashable.html#109" class="Field">hash</a> <a id="622" href="MidnightExample.Ledger.html#622" class="Bound">n</a> <a id="624" class="Symbol">=</a> <a id="626" href="Interface.Hashable.html#109" class="Field">hash</a> <a id="631" class="Symbol">(</a><a id="632" href="Agda.Builtin.Int.html#246" class="InductiveConstructor Operator">+</a> <a id="634" href="MidnightExample.Ledger.html#622" class="Bound">n</a><a id="635" class="Symbol">)</a>

<a id="_&lt;ᵇ_"></a><a id="638" href="MidnightExample.Ledger.html#638" class="Function Operator">_&lt;ᵇ_</a> <a id="643" class="Symbol">:</a> <a id="645" href="Agda.Builtin.Maybe.html#118" class="Datatype">Maybe</a> <a id="651" href="Agda.Builtin.Nat.html#186" class="Datatype">ℕ</a> <a id="653" class="Symbol">→</a> <a id="655" href="Agda.Builtin.Maybe.html#118" class="Datatype">Maybe</a> <a id="661" href="Agda.Builtin.Nat.html#186" class="Datatype">ℕ</a> <a id="663" class="Symbol">→</a> <a id="665" href="Agda.Builtin.Bool.html#156" class="Datatype">Bool</a>
<a id="670" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="675" href="MidnightExample.Ledger.html#675" class="Bound">a</a>  <a id="678" href="MidnightExample.Ledger.html#638" class="Function Operator">&lt;ᵇ</a> <a id="681" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="686" href="MidnightExample.Ledger.html#686" class="Bound">b</a>  <a id="689" class="Symbol">=</a> <a id="691" href="MidnightExample.Ledger.html#675" class="Bound">a</a> <a id="693" href="Data.Nat.Base.html#1301" class="Primitive Operator">Prelude.&lt;ᵇ</a> <a id="704" href="MidnightExample.Ledger.html#686" class="Bound">b</a>
<a id="706" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="711" href="MidnightExample.Ledger.html#711" class="Bound">a</a>  <a id="714" href="MidnightExample.Ledger.html#638" class="Function Operator">&lt;ᵇ</a> <a id="717" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a> <a id="725" class="Symbol">=</a> <a id="727" href="Agda.Builtin.Bool.html#175" class="InductiveConstructor">false</a>
<a id="733" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a> <a id="741" href="MidnightExample.Ledger.html#638" class="Function Operator">&lt;ᵇ</a> <a id="744" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="749" href="MidnightExample.Ledger.html#749" class="Bound">b</a>  <a id="752" class="Symbol">=</a> <a id="754" href="Agda.Builtin.Bool.html#181" class="InductiveConstructor">true</a>
<a id="759" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a> <a id="767" href="MidnightExample.Ledger.html#638" class="Function Operator">&lt;ᵇ</a> <a id="770" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a> <a id="778" class="Symbol">=</a> <a id="780" href="Agda.Builtin.Bool.html#175" class="InductiveConstructor">false</a>
<a id="786" class="Markup">\end{code}</a><a id="796" class="Background">

This is a small example of a ledger specification for Midnight. It
only assumes that we know how to hash some types and provides a step
function for the ledger together with a proof of a non-trivial
property.

\section{Epochs \&amp; Consensus}

We define the number of slots in an epoch and a conversion function
from slots to epochs here, as well as a structure to refer to certain
points in the chain.

\begin{figure*}[h]
\AgdaTarget{Point, slot, blockHash, slotsInEpoch, epochOf}
</a><a id="1277" class="Markup">\begin{code}</a>
<a id="1290" class="Keyword">record</a> <a id="Point"></a><a id="1297" href="MidnightExample.Ledger.html#1297" class="Record">Point</a> <a id="1303" class="Symbol">:</a> <a id="1305" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="1309" class="Keyword">where</a>
  <a id="1317" class="Keyword">field</a>  <a id="Point.slot"></a><a id="1324" href="MidnightExample.Ledger.html#1324" class="Field">slot</a>       <a id="1335" class="Symbol">:</a> <a id="1337" href="Agda.Builtin.Maybe.html#118" class="Datatype">Maybe</a> <a id="1343" href="Agda.Builtin.Nat.html#186" class="Datatype">ℕ</a>
         <a id="Point.blockHash"></a><a id="1354" href="MidnightExample.Ledger.html#1354" class="Field">blockHash</a>  <a id="1365" class="Symbol">:</a> <a id="1367" href="MidnightExample.Ledger.html#293" class="Bound">Hash</a>

<a id="slotsInEpoch"></a><a id="1373" href="MidnightExample.Ledger.html#1373" class="Function">slotsInEpoch</a> <a id="1386" class="Symbol">:</a> <a id="1388" href="Agda.Builtin.Nat.html#186" class="Datatype">ℕ</a>
<a id="1390" href="MidnightExample.Ledger.html#1373" class="Function">slotsInEpoch</a> <a id="1403" class="Symbol">=</a> <a id="1405" class="Number">50</a>

<a id="epochOf"></a><a id="1409" href="MidnightExample.Ledger.html#1409" class="Function">epochOf</a> <a id="1417" class="Symbol">:</a> <a id="1419" href="Agda.Builtin.Maybe.html#118" class="Datatype">Maybe</a> <a id="1425" href="Agda.Builtin.Nat.html#186" class="Datatype">ℕ</a> <a id="1427" class="Symbol">→</a> <a id="1429" href="Agda.Builtin.Maybe.html#118" class="Datatype">Maybe</a> <a id="1435" href="Agda.Builtin.Nat.html#186" class="Datatype">ℕ</a>
<a id="1437" href="MidnightExample.Ledger.html#1409" class="Function">epochOf</a> <a id="1445" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a>  <a id="1454" class="Symbol">=</a> <a id="1456" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a>
<a id="1464" href="MidnightExample.Ledger.html#1409" class="Function">epochOf</a> <a id="1472" class="Symbol">(</a><a id="1473" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="1478" href="MidnightExample.Ledger.html#1478" class="Bound">s</a><a id="1479" class="Symbol">)</a> <a id="1481" class="Symbol">=</a> <a id="1483" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="1488" class="Symbol">(</a><a id="1489" href="MidnightExample.Ledger.html#1478" class="Bound">s</a> <a id="1491" href="Data.Nat.Base.html#5077" class="Function Operator">/</a> <a id="1493" href="MidnightExample.Ledger.html#1373" class="Function">slotsInEpoch</a><a id="1505" class="Symbol">)</a>
<a id="1507" class="Markup">\end{code}</a><a id="1517" class="Background">
\caption{Point- and epoch-related definitions}
\end{figure*}

\newpage

\section{Transactions \&amp; Blocks}

Transactions can increment or decrement a counter that is stored in
the ledger, and blocks consist of a list of transactions and a header,
which contains some meta-information about the block. We also use the
accessor functions of the headers transitively, to access fields in
the header given the body.

\begin{figure*}[h]
\AgdaTarget{Tx, inc, dec, txDelta}
</a><a id="1983" class="Markup">\begin{code}</a>
<a id="1996" class="Keyword">data</a> <a id="Tx"></a><a id="2001" href="MidnightExample.Ledger.html#2001" class="Datatype">Tx</a> <a id="2004" class="Symbol">:</a> <a id="2006" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="2010" class="Keyword">where</a>
  <a id="Tx.inc"></a><a id="2018" href="MidnightExample.Ledger.html#2018" class="InductiveConstructor">inc</a>  <a id="2023" class="Symbol">:</a> <a id="2025" href="MidnightExample.Ledger.html#2001" class="Datatype">Tx</a>
  <a id="Tx.dec"></a><a id="2030" href="MidnightExample.Ledger.html#2030" class="InductiveConstructor">dec</a>  <a id="2035" class="Symbol">:</a> <a id="2037" href="MidnightExample.Ledger.html#2001" class="Datatype">Tx</a>

<a id="txDelta"></a><a id="2041" href="MidnightExample.Ledger.html#2041" class="Function">txDelta</a> <a id="2049" class="Symbol">:</a> <a id="2051" href="MidnightExample.Ledger.html#2001" class="Datatype">Tx</a> <a id="2054" class="Symbol">→</a> <a id="2056" href="Agda.Builtin.Int.html#228" class="Datatype">ℤ</a>
<a id="2058" href="MidnightExample.Ledger.html#2041" class="Function">txDelta</a> <a id="2066" href="MidnightExample.Ledger.html#2018" class="InductiveConstructor">inc</a>  <a id="2071" class="Symbol">=</a> <a id="2073" href="Data.Integer.Base.html#1558" class="Function">1ℤ</a>
<a id="2076" href="MidnightExample.Ledger.html#2041" class="Function">txDelta</a> <a id="2084" href="MidnightExample.Ledger.html#2030" class="InductiveConstructor">dec</a>  <a id="2089" class="Symbol">=</a> <a id="2091" href="Data.Integer.Base.html#1534" class="Function">-1ℤ</a>
<a id="2095" class="Markup">\end{code}</a><a id="2105" class="Background">
</a><a id="2106" class="Markup">\begin{code}[hide]</a>
<a id="2125" class="Keyword">instance</a>
  <a id="Hashable-Tx"></a><a id="2136" href="MidnightExample.Ledger.html#2136" class="Function">Hashable-Tx</a> <a id="2148" class="Symbol">:</a> <a id="2150" href="Interface.Hashable.html#64" class="Record">Hashable</a> <a id="2159" href="MidnightExample.Ledger.html#2001" class="Datatype">Tx</a> <a id="2162" href="MidnightExample.Ledger.html#293" class="Bound">Hash</a>
  <a id="2169" href="MidnightExample.Ledger.html#2136" class="Function">Hashable-Tx</a> <a id="2181" class="Symbol">.</a><a id="2182" href="Interface.Hashable.html#109" class="Field">hash</a> <a id="2187" class="Symbol">=</a> <a id="2189" href="Interface.Hashable.html#109" class="Field">hash</a> <a id="2194" href="Function.Base.html#1106" class="Function Operator">∘</a> <a id="2196" href="MidnightExample.Ledger.html#2041" class="Function">txDelta</a>
<a id="2204" class="Markup">\end{code}</a><a id="2214" class="Background">
\caption{Transactions}
\end{figure*}
\begin{figure*}[h]
\AgdaTarget{Header, slotNo, blockNo, blockHash, prev, nodeId, Block, header, body, blockPoint, computeBlockHash, addBlockHash}
</a><a id="2398" class="Markup">\begin{code}</a>
<a id="2411" class="Keyword">record</a> <a id="Header"></a><a id="2418" href="MidnightExample.Ledger.html#2418" class="Record">Header</a> <a id="2425" class="Symbol">:</a> <a id="2427" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="2431" class="Keyword">where</a>
  <a id="2439" class="Keyword">field</a>  <a id="Header.slotNo"></a><a id="2446" href="MidnightExample.Ledger.html#2446" class="Field">slotNo</a>     <a id="2457" class="Symbol">:</a> <a id="2459" href="Agda.Builtin.Nat.html#186" class="Datatype">ℕ</a>
         <a id="Header.blockNo"></a><a id="2470" href="MidnightExample.Ledger.html#2470" class="Field">blockNo</a>    <a id="2481" class="Symbol">:</a> <a id="2483" href="Agda.Builtin.Nat.html#186" class="Datatype">ℕ</a>
         <a id="Header.blockHash"></a><a id="2494" href="MidnightExample.Ledger.html#2494" class="Field">blockHash</a>  <a id="2505" class="Symbol">:</a> <a id="2507" href="MidnightExample.Ledger.html#293" class="Bound">Hash</a>
         <a id="Header.prev"></a><a id="2521" href="MidnightExample.Ledger.html#2521" class="Field">prev</a>       <a id="2532" class="Symbol">:</a> <a id="2534" href="Agda.Builtin.Nat.html#186" class="Datatype">ℕ</a>
         <a id="Header.nodeId"></a><a id="2545" href="MidnightExample.Ledger.html#2545" class="Field">nodeId</a>     <a id="2556" class="Symbol">:</a> <a id="2558" href="Agda.Builtin.Nat.html#186" class="Datatype">ℕ</a>

<a id="2561" class="Keyword">record</a> <a id="Block"></a><a id="2568" href="MidnightExample.Ledger.html#2568" class="Record">Block</a> <a id="2574" class="Symbol">:</a> <a id="2576" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="2580" class="Keyword">where</a>
  <a id="2588" class="Keyword">field</a>  <a id="Block.header"></a><a id="2595" href="MidnightExample.Ledger.html#2595" class="Field">header</a>  <a id="2603" class="Symbol">:</a> <a id="2605" href="MidnightExample.Ledger.html#2418" class="Record">Header</a>
         <a id="Block.body"></a><a id="2621" href="MidnightExample.Ledger.html#2621" class="Field">body</a>    <a id="2629" class="Symbol">:</a> <a id="2631" href="Agda.Builtin.List.html#130" class="Datatype">List</a> <a id="2636" href="MidnightExample.Ledger.html#2001" class="Datatype">Tx</a>

  <a id="2642" class="Keyword">open</a> <a id="2647" href="MidnightExample.Ledger.html#2418" class="Module">Header</a> <a id="2654" href="MidnightExample.Ledger.html#2595" class="Field">header</a> <a id="2661" class="Keyword">public</a>

<a id="blockPoint"></a><a id="2669" href="MidnightExample.Ledger.html#2669" class="Function">blockPoint</a> <a id="2680" class="Symbol">:</a> <a id="2682" href="MidnightExample.Ledger.html#2568" class="Record">Block</a> <a id="2688" class="Symbol">→</a> <a id="2690" href="MidnightExample.Ledger.html#1297" class="Record">Point</a>
<a id="2696" href="MidnightExample.Ledger.html#2669" class="Function">blockPoint</a> <a id="2707" href="MidnightExample.Ledger.html#2707" class="Bound">b</a> <a id="2709" class="Symbol">=</a> <a id="2711" class="Keyword">record</a> <a id="2718" class="Symbol">{</a> <a id="2720" href="MidnightExample.Ledger.html#1324" class="Field">slot</a> <a id="2725" class="Symbol">=</a> <a id="2727" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="2732" href="MidnightExample.Ledger.html#2446" class="Function">slotNo</a> <a id="2739" class="Symbol">;</a> <a id="2741" href="MidnightExample.Ledger.html#1354" class="Field">blockHash</a> <a id="2751" class="Symbol">=</a> <a id="2753" href="MidnightExample.Ledger.html#2494" class="Function">blockHash</a> <a id="2763" class="Symbol">}</a>
  <a id="2767" class="Keyword">where</a> <a id="2773" class="Keyword">open</a> <a id="2778" href="MidnightExample.Ledger.html#2568" class="Module">Block</a> <a id="2784" href="MidnightExample.Ledger.html#2707" class="Bound">b</a>

<a id="computeBlockHash"></a><a id="2787" href="MidnightExample.Ledger.html#2787" class="Function">computeBlockHash</a> <a id="2804" class="Symbol">:</a> <a id="2806" href="MidnightExample.Ledger.html#2568" class="Record">Block</a> <a id="2812" class="Symbol">→</a> <a id="2814" href="MidnightExample.Ledger.html#293" class="Bound">Hash</a>
<a id="2819" href="MidnightExample.Ledger.html#2787" class="Function">computeBlockHash</a> <a id="2836" href="MidnightExample.Ledger.html#2836" class="Bound">b</a> <a id="2838" class="Symbol">=</a> <a id="2840" href="Interface.Hashable.html#109" class="Field">hash</a> <a id="2845" class="Symbol">(</a><a id="2846" href="MidnightExample.Ledger.html#2446" class="Function">slotNo</a> <a id="2853" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="2855" href="MidnightExample.Ledger.html#2470" class="Function">blockNo</a> <a id="2863" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="2865" href="MidnightExample.Ledger.html#2521" class="Function">prev</a> <a id="2870" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="2872" href="MidnightExample.Ledger.html#2621" class="Field">body</a><a id="2876" class="Symbol">)</a>
  <a id="2880" class="Keyword">where</a> <a id="2886" class="Keyword">open</a> <a id="2891" href="MidnightExample.Ledger.html#2568" class="Module">Block</a> <a id="2897" href="MidnightExample.Ledger.html#2836" class="Bound">b</a>

<a id="addBlockHash"></a><a id="2900" href="MidnightExample.Ledger.html#2900" class="Function">addBlockHash</a> <a id="2913" class="Symbol">:</a> <a id="2915" href="MidnightExample.Ledger.html#2568" class="Record">Block</a> <a id="2921" class="Symbol">→</a> <a id="2923" href="MidnightExample.Ledger.html#2568" class="Record">Block</a>
<a id="2929" href="MidnightExample.Ledger.html#2900" class="Function">addBlockHash</a> <a id="2942" href="MidnightExample.Ledger.html#2942" class="Bound">b</a> <a id="2944" class="Symbol">=</a> <a id="2946" class="Keyword">record</a> <a id="2953" href="MidnightExample.Ledger.html#2942" class="Bound">b</a>
  <a id="2957" class="Symbol">{</a> <a id="2959" href="MidnightExample.Ledger.html#2595" class="Field">header</a> <a id="2966" class="Symbol">=</a> <a id="2968" class="Keyword">record</a> <a id="2975" href="MidnightExample.Ledger.html#2595" class="Field">header</a> <a id="2982" class="Symbol">{</a> <a id="2984" href="MidnightExample.Ledger.html#2494" class="Field">blockHash</a> <a id="2994" class="Symbol">=</a> <a id="2996" href="MidnightExample.Ledger.html#2787" class="Function">computeBlockHash</a> <a id="3013" href="MidnightExample.Ledger.html#2942" class="Bound">b</a> <a id="3015" class="Symbol">}</a> <a id="3017" class="Symbol">}</a>
  <a id="3021" class="Keyword">where</a> <a id="3027" class="Keyword">open</a> <a id="3032" href="MidnightExample.Ledger.html#2568" class="Module">Block</a> <a id="3038" href="MidnightExample.Ledger.html#2942" class="Bound">b</a>
<a id="3040" class="Markup">\end{code}</a><a id="3050" class="Background">
\caption{Blocks and functions related to them}
\end{figure*}

\newpage

\section{Ledger}

The ledger state consists of a pointer to the previous block as well as a counter and two snapshots. Ticking a ledger state means to roll over the snapshots.
\begin{figure*}[h]
\AgdaTarget{LedgerState, tip, count, snapshot1, snapshot2, tickLedgerState}
\begin{AgdaSuppressSpace}
</a><a id="3420" class="Markup">\begin{code}</a>
<a id="3433" class="Keyword">record</a> <a id="LedgerState"></a><a id="3440" href="MidnightExample.Ledger.html#3440" class="Record">LedgerState</a> <a id="3452" class="Symbol">:</a> <a id="3454" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="3458" class="Keyword">where</a>
  <a id="3466" class="Keyword">field</a>  <a id="LedgerState.tip"></a><a id="3473" href="MidnightExample.Ledger.html#3473" class="Field">tip</a>                  <a id="3494" class="Symbol">:</a> <a id="3496" href="MidnightExample.Ledger.html#1297" class="Record">Point</a>
         <a id="LedgerState.count"></a><a id="3511" href="MidnightExample.Ledger.html#3511" class="Field">count</a>                <a id="3532" class="Symbol">:</a> <a id="3534" href="Agda.Builtin.Int.html#228" class="Datatype">ℤ</a>
         <a id="LedgerState.snapshot1"></a><a id="3545" href="MidnightExample.Ledger.html#3545" class="Field">snapshot1</a> <a id="LedgerState.snapshot2"></a><a id="3555" href="MidnightExample.Ledger.html#3555" class="Field">snapshot2</a>  <a id="3566" class="Symbol">:</a> <a id="3568" href="Agda.Builtin.Int.html#228" class="Datatype">ℤ</a>

<a id="3571" class="Markup">\end{code}</a><a id="3581" class="Background">
</a><a id="3582" class="Markup">\begin{code}[hide]</a>
<a id="3601" class="Keyword">open</a> <a id="3606" href="MidnightExample.Ledger.html#3440" class="Module">LedgerState</a>
<a id="3618" class="Markup">\end{code}</a><a id="3628" class="Background">
</a><a id="3629" class="Markup">\begin{code}</a>
<a id="tickLedgerState"></a><a id="3642" href="MidnightExample.Ledger.html#3642" class="Function">tickLedgerState</a> <a id="3658" class="Symbol">:</a> <a id="3660" href="Agda.Builtin.Nat.html#186" class="Datatype">ℕ</a> <a id="3662" class="Symbol">→</a> <a id="3664" href="MidnightExample.Ledger.html#3440" class="Record">LedgerState</a> <a id="3676" class="Symbol">→</a> <a id="3678" href="MidnightExample.Ledger.html#3440" class="Record">LedgerState</a>
<a id="3690" href="MidnightExample.Ledger.html#3642" class="Function">tickLedgerState</a> <a id="3706" href="MidnightExample.Ledger.html#3706" class="Bound">newSlot</a> <a id="3714" href="MidnightExample.Ledger.html#3714" class="Bound">st</a> <a id="3717" class="Symbol">=</a> <a id="3719" href="Data.Bool.Base.html#1283" class="Function Operator">if</a> <a id="3722" href="MidnightExample.Ledger.html#3820" class="Function">isNewEpoch</a>
  <a id="3735" href="Data.Bool.Base.html#1283" class="Function Operator">then</a> <a id="3740" class="Keyword">record</a> <a id="3747" href="MidnightExample.Ledger.html#3714" class="Bound">st</a> <a id="3750" class="Symbol">{</a> <a id="3752" href="MidnightExample.Ledger.html#3545" class="Field">snapshot1</a> <a id="3762" class="Symbol">=</a> <a id="3764" href="MidnightExample.Ledger.html#3511" class="Field">count</a> <a id="3770" href="MidnightExample.Ledger.html#3714" class="Bound">st</a> <a id="3773" class="Symbol">;</a> <a id="3775" href="MidnightExample.Ledger.html#3555" class="Field">snapshot2</a> <a id="3785" class="Symbol">=</a> <a id="3787" href="MidnightExample.Ledger.html#3545" class="Field">snapshot1</a> <a id="3797" href="MidnightExample.Ledger.html#3714" class="Bound">st</a> <a id="3800" class="Symbol">}</a>
  <a id="3804" href="Data.Bool.Base.html#1283" class="Function Operator">else</a> <a id="3809" href="MidnightExample.Ledger.html#3714" class="Bound">st</a>
  <a id="3814" class="Keyword">where</a> <a id="3820" href="MidnightExample.Ledger.html#3820" class="Function">isNewEpoch</a> <a id="3831" class="Symbol">=</a> <a id="3833" href="MidnightExample.Ledger.html#1409" class="Function">epochOf</a> <a id="3841" class="Symbol">(</a><a id="3842" href="MidnightExample.Ledger.html#1324" class="Field">Point.slot</a> <a id="3853" class="Symbol">(</a><a id="3854" href="MidnightExample.Ledger.html#3473" class="Field">tip</a> <a id="3858" href="MidnightExample.Ledger.html#3714" class="Bound">st</a><a id="3860" class="Symbol">))</a> <a id="3863" href="MidnightExample.Ledger.html#638" class="Function Operator">&lt;ᵇ</a> <a id="3866" href="MidnightExample.Ledger.html#1409" class="Function">epochOf</a> <a id="3874" class="Symbol">(</a><a id="3875" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="3880" href="MidnightExample.Ledger.html#3706" class="Bound">newSlot</a><a id="3887" class="Symbol">)</a>
<a id="3889" class="Markup">\end{code}</a><a id="3899" class="Background">
\end{AgdaSuppressSpace}
\caption{Ledger state and its tick function}
\end{figure*}

The ledger transition system updates the tip to point to the most
recent applied block, and increments/decrements the counter according
to the transactions. We also want to check some non-trivial
conditions, so we require the change to the counter to be non-zero and
that the hash in the header is correct.

\begin{figure*}[h]
\AgdaTarget{\_⊢\_⇀⦇\_,LEDGER⦈\_, LEDGER-inductive}
</a><a id="4362" class="Markup">\begin{code}</a>
<a id="4375" class="Keyword">data</a> <a id="_⊢_⇀⦇_,LEDGER⦈_"></a><a id="4380" href="MidnightExample.Ledger.html#4380" class="Datatype Operator">_⊢_⇀⦇_,LEDGER⦈_</a> <a id="4396" class="Symbol">:</a> <a id="4398" href="Agda.Builtin.Unit.html#158" class="Record">⊤</a> <a id="4400" class="Symbol">→</a> <a id="4402" href="MidnightExample.Ledger.html#3440" class="Record">LedgerState</a> <a id="4414" class="Symbol">→</a> <a id="4416" href="MidnightExample.Ledger.html#2568" class="Record">Block</a> <a id="4422" class="Symbol">→</a> <a id="4424" href="MidnightExample.Ledger.html#3440" class="Record">LedgerState</a> <a id="4436" class="Symbol">→</a> <a id="4438" href="Agda.Primitive.html#320" class="Primitive">Set</a> <a id="4442" class="Keyword">where</a>
  <a id="_⊢_⇀⦇_,LEDGER⦈_.LEDGER-inductive"></a><a id="4450" href="MidnightExample.Ledger.html#4450" class="InductiveConstructor">LEDGER-inductive</a> <a id="4467" class="Symbol">:</a> <a id="4469" class="Symbol">∀</a> <a id="4471" class="Symbol">{</a><a id="4472" href="MidnightExample.Ledger.html#4472" class="Bound">Γ</a><a id="4473" class="Symbol">}</a> <a id="4475" class="Symbol">{</a><a id="4476" href="MidnightExample.Ledger.html#4476" class="Bound">s</a><a id="4477" class="Symbol">}</a> <a id="4479" class="Symbol">{</a><a id="4480" href="MidnightExample.Ledger.html#4480" class="Bound">b</a><a id="4481" class="Symbol">}</a> <a id="4483" class="Symbol">→</a>
    <a id="4489" class="Keyword">let</a> <a id="4493" class="Keyword">open</a> <a id="4498" href="MidnightExample.Ledger.html#2568" class="Module">Block</a> <a id="4504" href="MidnightExample.Ledger.html#4480" class="Bound">b</a>
        <a id="4514" href="MidnightExample.Ledger.html#4514" class="Bound">acc</a> <a id="4518" class="Symbol">=</a> <a id="4520" href="Axiom.Set.Sum.html#1683" class="Function">Σˡ[</a> <a id="4524" href="MidnightExample.Ledger.html#4524" class="Bound">x</a> <a id="4526" href="Axiom.Set.Sum.html#1683" class="Function">←</a> <a id="4528" href="MidnightExample.Ledger.html#2621" class="Field">body</a> <a id="4533" href="Axiom.Set.Sum.html#1683" class="Function">]</a> <a id="4535" href="MidnightExample.Ledger.html#2041" class="Function">txDelta</a> <a id="4543" href="MidnightExample.Ledger.html#4524" class="Bound">x</a>
        <a id="4553" href="MidnightExample.Ledger.html#4553" class="Bound">s&#39;</a>  <a id="4557" class="Symbol">=</a> <a id="4559" href="MidnightExample.Ledger.html#3642" class="Function">tickLedgerState</a> <a id="4575" href="MidnightExample.Ledger.html#2446" class="Function">slotNo</a> <a id="4582" href="MidnightExample.Ledger.html#4476" class="Bound">s</a>
    <a id="4588" class="Keyword">in</a> <a id="4591" href="Interface.STS.html#138" class="Function Operator">∙</a> <a id="4593" href="MidnightExample.Ledger.html#4514" class="Bound">acc</a> <a id="4597" href="Relation.Binary.PropositionalEquality.Core.html#844" class="Function Operator">≢</a> <a id="4599" href="Data.Integer.Base.html#1518" class="Function">0ℤ</a>        <a id="4609" href="Interface.STS.html#162" class="Function Operator">∙</a> <a id="4611" href="MidnightExample.Ledger.html#2787" class="Function">computeBlockHash</a> <a id="4628" href="MidnightExample.Ledger.html#4480" class="Bound">b</a> <a id="4630" href="Agda.Builtin.Equality.html#133" class="Datatype Operator">≡</a> <a id="4632" href="MidnightExample.Ledger.html#2494" class="Function">blockHash</a>
    <a id="4646" href="Interface.STS.html#244" class="Function Operator">────────────────────────────────</a>
    <a id="4683" href="MidnightExample.Ledger.html#4472" class="Bound">Γ</a> <a id="4685" href="MidnightExample.Ledger.html#4380" class="Datatype Operator">⊢</a> <a id="4687" href="MidnightExample.Ledger.html#4476" class="Bound">s</a> <a id="4689" href="MidnightExample.Ledger.html#4380" class="Datatype Operator">⇀⦇</a> <a id="4692" href="MidnightExample.Ledger.html#4480" class="Bound">b</a> <a id="4694" href="MidnightExample.Ledger.html#4380" class="Datatype Operator">,LEDGER⦈</a>
      <a id="4709" class="Keyword">record</a> <a id="4716" href="MidnightExample.Ledger.html#4553" class="Bound">s&#39;</a> <a id="4719" class="Symbol">{</a> <a id="4721" href="MidnightExample.Ledger.html#3473" class="Field">tip</a> <a id="4725" class="Symbol">=</a> <a id="4727" href="MidnightExample.Ledger.html#2669" class="Function">blockPoint</a> <a id="4738" href="MidnightExample.Ledger.html#4480" class="Bound">b</a> <a id="4740" class="Symbol">;</a> <a id="4742" href="MidnightExample.Ledger.html#3511" class="Field">count</a> <a id="4748" class="Symbol">=</a> <a id="4750" href="MidnightExample.Ledger.html#3511" class="Field">count</a> <a id="4756" href="MidnightExample.Ledger.html#4476" class="Bound">s</a> <a id="4758" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="4760" href="MidnightExample.Ledger.html#4514" class="Bound">acc</a> <a id="4764" class="Symbol">}</a>
<a id="4766" class="Markup">\end{code}</a><a id="4776" class="Background">
\caption{The LEDGER transition system}
\end{figure*}

We can prove that this relation is a partial function and the proof gives us a step function.
As an example we also provide a function that does the same computation explicitly.

</a><a id="5010" class="Markup">\begin{code}[hide]</a>
<a id="5029" class="Keyword">open</a> <a id="5034" href="Interface.ComputationalRelation.html#627" class="Module">Computational</a> <a id="5048" class="Symbol">⦃...⦄</a>
<a id="5054" class="Keyword">instance</a>
  <a id="Computational-LEDGER"></a><a id="5065" href="MidnightExample.Ledger.html#5065" class="Function">Computational-LEDGER</a> <a id="5086" class="Symbol">:</a> <a id="5088" href="Interface.ComputationalRelation.html#627" class="Record">Computational</a> <a id="5102" href="MidnightExample.Ledger.html#4380" class="Datatype Operator">_⊢_⇀⦇_,LEDGER⦈_</a>
  <a id="5120" href="MidnightExample.Ledger.html#5065" class="Function">Computational-LEDGER</a> <a id="5141" class="Symbol">.</a><a id="5142" href="Interface.ComputationalRelation.html#701" class="Field">computeProof</a> <a id="5155" href="MidnightExample.Ledger.html#5155" class="Bound">Γ</a> <a id="5157" href="MidnightExample.Ledger.html#5157" class="Bound">s</a> <a id="5159" href="MidnightExample.Ledger.html#5159" class="Bound">b</a> <a id="5161" class="Symbol">=</a>
    <a id="5167" class="Keyword">let</a> <a id="5171" class="Keyword">open</a> <a id="5176" href="MidnightExample.Ledger.html#2568" class="Module">Block</a> <a id="5182" href="MidnightExample.Ledger.html#5159" class="Bound">b</a>
        <a id="5192" href="MidnightExample.Ledger.html#5192" class="Bound">acc</a> <a id="5196" class="Symbol">=</a> <a id="5198" href="Axiom.Set.Sum.html#1683" class="Function">Σˡ[</a> <a id="5202" href="MidnightExample.Ledger.html#5202" class="Bound">x</a> <a id="5204" href="Axiom.Set.Sum.html#1683" class="Function">←</a> <a id="5206" href="MidnightExample.Ledger.html#2621" class="Field">body</a> <a id="5211" href="Axiom.Set.Sum.html#1683" class="Function">]</a> <a id="5213" href="MidnightExample.Ledger.html#2041" class="Function">txDelta</a> <a id="5221" href="MidnightExample.Ledger.html#5202" class="Bound">x</a>
    <a id="5227" class="Keyword">in</a> <a id="5230" href="Function.Base.html#4053" class="Function Operator">case</a> <a id="5235" href="Interface.Decidable.Instance.html#739" class="Function Operator">¿</a> <a id="5237" href="MidnightExample.Ledger.html#5192" class="Bound">acc</a> <a id="5241" href="Relation.Binary.PropositionalEquality.Core.html#844" class="Function Operator">≢</a> <a id="5243" href="Data.Integer.Base.html#1518" class="Function">0ℤ</a> <a id="5246" href="MidnightExample.Ledger.html#205" class="Function Operator">∧</a> <a id="5248" href="MidnightExample.Ledger.html#2787" class="Function">computeBlockHash</a> <a id="5265" href="MidnightExample.Ledger.html#5159" class="Bound">b</a> <a id="5267" href="Agda.Builtin.Equality.html#133" class="Datatype Operator">≡</a> <a id="5269" href="MidnightExample.Ledger.html#2494" class="Function">blockHash</a> <a id="5279" href="Interface.Decidable.Instance.html#739" class="Function Operator">¿</a> <a id="5281" href="Function.Base.html#4053" class="Function Operator">of</a> <a id="5284" class="Symbol">λ</a> <a id="5286" class="Keyword">where</a>
      <a id="5298" class="Symbol">(</a><a id="5299" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="5303" class="Symbol">(</a><a id="5304" href="MidnightExample.Ledger.html#5304" class="Bound">p</a> <a id="5306" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="5308" href="MidnightExample.Ledger.html#5308" class="Bound">p₁</a><a id="5310" class="Symbol">))</a> <a id="5313" class="Symbol">→</a> <a id="5315" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="5320" class="Symbol">(_</a> <a id="5323" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="5325" href="MidnightExample.Ledger.html#4450" class="InductiveConstructor">LEDGER-inductive</a> <a id="5342" href="MidnightExample.Ledger.html#5304" class="Bound">p</a> <a id="5344" href="MidnightExample.Ledger.html#5308" class="Bound">p₁</a><a id="5346" class="Symbol">)</a>
      <a id="5354" class="Symbol">(</a><a id="5355" href="Relation.Nullary.Decidable.Core.html#1650" class="InductiveConstructor">no</a> <a id="5358" class="Symbol">_)</a> <a id="5361" class="Symbol">→</a> <a id="5363" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a>
  <a id="5373" href="MidnightExample.Ledger.html#5065" class="Function">Computational-LEDGER</a> <a id="5394" class="Symbol">.</a><a id="5395" href="Interface.ComputationalRelation.html#884" class="Field">completeness</a> <a id="5408" href="MidnightExample.Ledger.html#5408" class="Bound">Γ</a> <a id="5410" href="MidnightExample.Ledger.html#5410" class="Bound">s</a> <a id="5412" href="MidnightExample.Ledger.html#5412" class="Bound">b</a> <a id="5414" href="MidnightExample.Ledger.html#5414" class="Bound">s&#39;</a> <a id="5417" class="Symbol">(</a><a id="5418" href="MidnightExample.Ledger.html#4450" class="InductiveConstructor">LEDGER-inductive</a> <a id="5435" href="MidnightExample.Ledger.html#5435" class="Bound">p</a> <a id="5437" href="MidnightExample.Ledger.html#5437" class="Bound">p₁</a><a id="5439" class="Symbol">)</a>
    <a id="5445" class="Keyword">rewrite</a> <a id="5453" class="Symbol">(</a><a id="5454" class="Keyword">let</a> <a id="5458" class="Keyword">open</a> <a id="5463" href="MidnightExample.Ledger.html#2568" class="Module">Block</a> <a id="5469" href="MidnightExample.Ledger.html#5412" class="Bound">b</a><a id="5470" class="Symbol">;</a> <a id="5472" href="MidnightExample.Ledger.html#5472" class="Bound">acc</a> <a id="5476" class="Symbol">=</a> <a id="5478" href="Axiom.Set.Sum.html#1683" class="Function">Σˡ[</a> <a id="5482" href="MidnightExample.Ledger.html#5482" class="Bound">x</a> <a id="5484" href="Axiom.Set.Sum.html#1683" class="Function">←</a> <a id="5486" href="MidnightExample.Ledger.html#2621" class="Function">body</a> <a id="5491" href="Axiom.Set.Sum.html#1683" class="Function">]</a> <a id="5493" href="MidnightExample.Ledger.html#2041" class="Function">txDelta</a> <a id="5501" href="MidnightExample.Ledger.html#5482" class="Bound">x</a>
             <a id="5516" class="Keyword">in</a> <a id="5519" href="Relation.Nullary.Decidable.html#2677" class="Function">dec-yes</a> <a id="5527" href="Interface.Decidable.Instance.html#739" class="Function Operator">¿</a> <a id="5529" href="MidnightExample.Ledger.html#5472" class="Bound">acc</a> <a id="5533" href="Relation.Binary.PropositionalEquality.Core.html#844" class="Function Operator">≢</a> <a id="5535" href="Data.Integer.Base.html#1518" class="Function">0ℤ</a> <a id="5538" href="MidnightExample.Ledger.html#205" class="Function Operator">∧</a> <a id="5540" href="MidnightExample.Ledger.html#2787" class="Function">computeBlockHash</a> <a id="5557" href="MidnightExample.Ledger.html#5412" class="Bound">b</a> <a id="5559" href="Agda.Builtin.Equality.html#133" class="Datatype Operator">≡</a> <a id="5561" href="MidnightExample.Ledger.html#2494" class="Function">blockHash</a> <a id="5571" href="Interface.Decidable.Instance.html#739" class="Function Operator">¿</a> <a id="5573" class="Symbol">(</a><a id="5574" href="MidnightExample.Ledger.html#5435" class="Bound">p</a> <a id="5576" href="Agda.Builtin.Sigma.html#218" class="InductiveConstructor Operator">,</a> <a id="5578" href="MidnightExample.Ledger.html#5437" class="Bound">p₁</a><a id="5580" class="Symbol">)</a> <a id="5582" class="Symbol">.</a><a id="5583" href="Data.Product.Base.html#622" class="Field">proj₂</a><a id="5588" class="Symbol">)</a> <a id="5590" class="Symbol">=</a> <a id="5592" href="Agda.Builtin.Equality.html#190" class="InductiveConstructor">refl</a>
<a id="5597" class="Markup">\end{code}</a><a id="5607" class="Background">
\begin{figure*}[h]
</a><a id="5627" class="Markup">\begin{code}</a>
<a id="LEDGER-step"></a><a id="5640" href="MidnightExample.Ledger.html#5640" class="Function">LEDGER-step</a> <a id="5652" class="Symbol">:</a> <a id="5654" href="Agda.Builtin.Unit.html#158" class="Record">⊤</a> <a id="5656" class="Symbol">→</a> <a id="5658" href="MidnightExample.Ledger.html#3440" class="Record">LedgerState</a> <a id="5670" class="Symbol">→</a> <a id="5672" href="MidnightExample.Ledger.html#2568" class="Record">Block</a> <a id="5678" class="Symbol">→</a> <a id="5680" href="Agda.Builtin.Maybe.html#118" class="Datatype">Maybe</a> <a id="5686" href="MidnightExample.Ledger.html#3440" class="Record">LedgerState</a>
<a id="5698" href="MidnightExample.Ledger.html#5640" class="Function">LEDGER-step</a> <a id="5710" class="Symbol">=</a> <a id="5712" href="Interface.ComputationalRelation.html#782" class="Function">compute</a>

<a id="applyBlockTo"></a><a id="5721" href="MidnightExample.Ledger.html#5721" class="Function">applyBlockTo</a> <a id="5734" class="Symbol">:</a> <a id="5736" href="MidnightExample.Ledger.html#2568" class="Record">Block</a> <a id="5742" class="Symbol">→</a> <a id="5744" href="MidnightExample.Ledger.html#3440" class="Record">LedgerState</a> <a id="5756" class="Symbol">→</a> <a id="5758" href="Agda.Builtin.Maybe.html#118" class="Datatype">Maybe</a> <a id="5764" href="MidnightExample.Ledger.html#3440" class="Record">LedgerState</a>
<a id="5776" href="MidnightExample.Ledger.html#5721" class="Function">applyBlockTo</a> <a id="5789" href="MidnightExample.Ledger.html#5789" class="Bound">b</a> <a id="5791" href="MidnightExample.Ledger.html#5791" class="Bound">st</a> <a id="5794" class="Symbol">=</a> <a id="5796" class="Keyword">let</a> <a id="5800" href="MidnightExample.Ledger.html#5800" class="Bound">acc</a> <a id="5804" class="Symbol">=</a> <a id="5806" href="Axiom.Set.Sum.html#1683" class="Function">Σˡ[</a> <a id="5810" href="MidnightExample.Ledger.html#5810" class="Bound">x</a> <a id="5812" href="Axiom.Set.Sum.html#1683" class="Function">←</a> <a id="5814" href="MidnightExample.Ledger.html#2621" class="Field">Block.body</a> <a id="5825" href="MidnightExample.Ledger.html#5789" class="Bound">b</a> <a id="5827" href="Axiom.Set.Sum.html#1683" class="Function">]</a> <a id="5829" href="MidnightExample.Ledger.html#2041" class="Function">txDelta</a> <a id="5837" href="MidnightExample.Ledger.html#5810" class="Bound">x</a> <a id="5839" class="Keyword">in</a>
  <a id="5844" href="Interface.Decidable.Instance.html#881" class="Function Operator">ifᵈ</a> <a id="5848" href="MidnightExample.Ledger.html#5800" class="Bound">acc</a> <a id="5852" href="Relation.Binary.PropositionalEquality.Core.html#844" class="Function Operator">≢</a> <a id="5854" href="Data.Integer.Base.html#1518" class="Function">0ℤ</a> <a id="5857" href="MidnightExample.Ledger.html#205" class="Function Operator">∧</a> <a id="5859" href="MidnightExample.Ledger.html#2787" class="Function">computeBlockHash</a> <a id="5876" href="MidnightExample.Ledger.html#5789" class="Bound">b</a> <a id="5878" href="Agda.Builtin.Equality.html#133" class="Datatype Operator">≡</a> <a id="5880" href="MidnightExample.Ledger.html#2494" class="Function">Block.blockHash</a> <a id="5896" href="MidnightExample.Ledger.html#5789" class="Bound">b</a>
    <a id="5902" href="Interface.Decidable.Instance.html#881" class="Function Operator">then</a> <a id="5907" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="5912" class="Keyword">record</a> <a id="5919" href="MidnightExample.Ledger.html#5791" class="Bound">st</a> <a id="5922" class="Symbol">{</a> <a id="5924" href="MidnightExample.Ledger.html#3473" class="Field">tip</a> <a id="5928" class="Symbol">=</a> <a id="5930" href="MidnightExample.Ledger.html#2669" class="Function">blockPoint</a> <a id="5941" href="MidnightExample.Ledger.html#5789" class="Bound">b</a> <a id="5943" class="Symbol">;</a> <a id="5945" href="MidnightExample.Ledger.html#3511" class="Field">count</a> <a id="5951" class="Symbol">=</a> <a id="5953" href="MidnightExample.Ledger.html#3511" class="Field">count</a> <a id="5959" href="MidnightExample.Ledger.html#5791" class="Bound">st</a> <a id="5962" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="5964" href="MidnightExample.Ledger.html#5800" class="Bound">acc</a> <a id="5968" class="Symbol">}</a>
    <a id="5974" href="Interface.Decidable.Instance.html#881" class="Function Operator">else</a> <a id="5979" href="Agda.Builtin.Maybe.html#177" class="InductiveConstructor">nothing</a>
<a id="5987" class="Markup">\end{code}</a><a id="5997" class="Background">
\end{figure*}

\newpage

\section{Key properties}

This is Agda, so we can prove some properties. Since we check very few
things, and just repeating properties that we do check isn&#39;t
interesting, here&#39;s the only non-trivial property that I could think
of: That the counter in the ledger state does change.

We present three proofs here, one using the STS, one using the step
function generated from the STS, and one using the
\AgdaFunction{applyBlockTo} function to show why using the STS is more
convenient for proofs: Instead of tracing the function control flow to
extract properties, we can simply pattern-match for them. After we
obtained fact that the sum of changes induced by transactions is
non-zero, the proofs are identical.

</a><a id="6735" class="Markup">\begin{code}[hide]</a>
<a id="6754" class="Keyword">private</a> <a id="6762" class="Keyword">variable</a>
  <a id="6773" href="MidnightExample.Ledger.html#6773" class="Generalizable">s</a> <a id="6775" href="MidnightExample.Ledger.html#6775" class="Generalizable">s&#39;</a> <a id="6778" class="Symbol">:</a> <a id="6780" href="MidnightExample.Ledger.html#3440" class="Record">LedgerState</a>
  <a id="6794" href="MidnightExample.Ledger.html#6794" class="Generalizable">b</a> <a id="6796" class="Symbol">:</a> <a id="6798" href="MidnightExample.Ledger.html#2568" class="Record">Block</a>

<a id="6805" class="Keyword">open</a> <a id="6810" class="Keyword">import</a> <a id="6817" href="Algebra.Properties.AbelianGroup.html" class="Module">Algebra.Properties.AbelianGroup</a> <a id="6849" href="Data.Integer.Properties.html#31618" class="Function">+-0-abelianGroup</a>
<a id="6866" class="Markup">\end{code}</a><a id="6876" class="Background">
\begin{figure*}[h]
</a><a id="6896" class="Markup">\begin{code}</a>
<a id="lemma"></a><a id="6909" href="MidnightExample.Ledger.html#6909" class="Function">lemma</a> <a id="6915" class="Symbol">:</a> <a id="6917" class="Symbol">∀</a> <a id="6919" class="Symbol">{</a><a id="6920" href="MidnightExample.Ledger.html#6920" class="Bound">x</a> <a id="6922" href="MidnightExample.Ledger.html#6922" class="Bound">y</a><a id="6923" class="Symbol">}</a> <a id="6925" class="Symbol">→</a> <a id="6927" href="MidnightExample.Ledger.html#6922" class="Bound">y</a> <a id="6929" href="Relation.Binary.PropositionalEquality.Core.html#844" class="Function Operator">≢</a> <a id="6931" href="Data.Integer.Base.html#1518" class="Function">0ℤ</a> <a id="6934" class="Symbol">→</a> <a id="6936" href="MidnightExample.Ledger.html#6920" class="Bound">x</a> <a id="6938" href="Relation.Binary.PropositionalEquality.Core.html#844" class="Function Operator">≢</a> <a id="6940" href="MidnightExample.Ledger.html#6920" class="Bound">x</a> <a id="6942" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="6944" href="MidnightExample.Ledger.html#6922" class="Bound">y</a>
<a id="6946" href="MidnightExample.Ledger.html#6909" class="Function">lemma</a> <a id="6952" href="MidnightExample.Ledger.html#6952" class="Bound">y≢0</a> <a id="6956" href="MidnightExample.Ledger.html#6956" class="Bound">eq</a> <a id="6959" class="Symbol">=</a> <a id="6961" href="MidnightExample.Ledger.html#6952" class="Bound">y≢0</a> <a id="6965" class="Symbol">(</a><a id="6966" href="Algebra.Properties.Group.html#2443" class="Function">identityʳ-unique</a> <a id="6983" class="Symbol">_</a> <a id="6985" class="Symbol">_</a> <a id="6987" class="Symbol">(</a><a id="6988" href="Relation.Binary.PropositionalEquality.Core.html#1698" class="Function">sym</a> <a id="6992" href="MidnightExample.Ledger.html#6956" class="Bound">eq</a><a id="6994" class="Symbol">))</a>

<a id="LEDGER-property₁"></a><a id="6998" href="MidnightExample.Ledger.html#6998" class="Function">LEDGER-property₁</a> <a id="7015" class="Symbol">:</a> <a id="7017" class="Symbol">_</a> <a id="7019" href="MidnightExample.Ledger.html#4380" class="Datatype Operator">⊢</a> <a id="7021" href="MidnightExample.Ledger.html#6773" class="Generalizable">s</a> <a id="7023" href="MidnightExample.Ledger.html#4380" class="Datatype Operator">⇀⦇</a> <a id="7026" href="MidnightExample.Ledger.html#6794" class="Generalizable">b</a> <a id="7028" href="MidnightExample.Ledger.html#4380" class="Datatype Operator">,LEDGER⦈</a> <a id="7037" href="MidnightExample.Ledger.html#6775" class="Generalizable">s&#39;</a> <a id="7040" class="Symbol">→</a> <a id="7042" href="MidnightExample.Ledger.html#3511" class="Field">count</a> <a id="7048" href="MidnightExample.Ledger.html#6773" class="Generalizable">s</a> <a id="7050" href="Relation.Binary.PropositionalEquality.Core.html#844" class="Function Operator">≢</a> <a id="7052" href="MidnightExample.Ledger.html#3511" class="Field">count</a> <a id="7058" href="MidnightExample.Ledger.html#6775" class="Generalizable">s&#39;</a>
<a id="7061" href="MidnightExample.Ledger.html#6998" class="Function">LEDGER-property₁</a> <a id="7078" class="Symbol">(</a><a id="7079" href="MidnightExample.Ledger.html#4450" class="InductiveConstructor">LEDGER-inductive</a> <a id="7096" href="MidnightExample.Ledger.html#7096" class="Bound">acc≢0</a> <a id="7102" class="Symbol">_)</a> <a id="7105" class="Symbol">=</a> <a id="7107" href="MidnightExample.Ledger.html#6909" class="Function">lemma</a> <a id="7113" href="MidnightExample.Ledger.html#7096" class="Bound">acc≢0</a>

<a id="LEDGER-property₂"></a><a id="7120" href="MidnightExample.Ledger.html#7120" class="Function">LEDGER-property₂</a> <a id="7137" class="Symbol">:</a> <a id="7139" href="MidnightExample.Ledger.html#5640" class="Function">LEDGER-step</a> <a id="7151" class="Symbol">_</a> <a id="7153" href="MidnightExample.Ledger.html#6773" class="Generalizable">s</a> <a id="7155" href="MidnightExample.Ledger.html#6794" class="Generalizable">b</a> <a id="7157" href="Agda.Builtin.Equality.html#133" class="Datatype Operator">≡</a> <a id="7159" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="7164" href="MidnightExample.Ledger.html#6775" class="Generalizable">s&#39;</a> <a id="7167" class="Symbol">→</a> <a id="7169" href="MidnightExample.Ledger.html#3511" class="Field">count</a> <a id="7175" href="MidnightExample.Ledger.html#6773" class="Generalizable">s</a> <a id="7177" href="Relation.Binary.PropositionalEquality.Core.html#844" class="Function Operator">≢</a> <a id="7179" href="MidnightExample.Ledger.html#3511" class="Field">count</a> <a id="7185" href="MidnightExample.Ledger.html#6775" class="Generalizable">s&#39;</a>
<a id="7188" href="MidnightExample.Ledger.html#7120" class="Function">LEDGER-property₂</a> <a id="7205" class="Symbol">{</a><a id="7206" href="MidnightExample.Ledger.html#7206" class="Bound">s</a><a id="7207" class="Symbol">}</a> <a id="7209" class="Symbol">{</a><a id="7210" href="MidnightExample.Ledger.html#7210" class="Bound">b</a><a id="7211" class="Symbol">}</a> <a id="7213" href="MidnightExample.Ledger.html#7213" class="Bound">eq</a>
  <a id="7218" class="Symbol">=</a> <a id="7220" href="MidnightExample.Ledger.html#6998" class="Function">LEDGER-property₁</a>
  <a id="7239" href="Function.Base.html#1994" class="Function Operator">$</a> <a id="7241" href="Function.Bundles.html#4398" class="Field">Equivalence.to</a> <a id="7256" class="Symbol">(</a><a id="7257" href="Interface.ComputationalRelation.html#1016" class="Function">≡-just⇔STS</a> <a id="7268" class="Symbol">{</a><a id="7269" class="Argument">s</a> <a id="7271" class="Symbol">=</a> <a id="7273" href="MidnightExample.Ledger.html#7206" class="Bound">s</a><a id="7274" class="Symbol">}</a> <a id="7276" class="Symbol">{</a><a id="7277" class="Argument">sig</a> <a id="7281" class="Symbol">=</a> <a id="7283" href="MidnightExample.Ledger.html#7210" class="Bound">b</a><a id="7284" class="Symbol">})</a> <a id="7287" href="MidnightExample.Ledger.html#7213" class="Bound">eq</a>

<a id="LEDGER-property₃"></a><a id="7291" href="MidnightExample.Ledger.html#7291" class="Function">LEDGER-property₃</a> <a id="7308" class="Symbol">:</a> <a id="7310" href="MidnightExample.Ledger.html#5721" class="Function">applyBlockTo</a> <a id="7323" href="MidnightExample.Ledger.html#6794" class="Generalizable">b</a> <a id="7325" href="MidnightExample.Ledger.html#6773" class="Generalizable">s</a> <a id="7327" href="Agda.Builtin.Equality.html#133" class="Datatype Operator">≡</a> <a id="7329" href="Agda.Builtin.Maybe.html#156" class="InductiveConstructor">just</a> <a id="7334" href="MidnightExample.Ledger.html#6775" class="Generalizable">s&#39;</a> <a id="7337" class="Symbol">→</a> <a id="7339" href="MidnightExample.Ledger.html#3511" class="Field">count</a> <a id="7345" href="MidnightExample.Ledger.html#6773" class="Generalizable">s</a> <a id="7347" href="Relation.Binary.PropositionalEquality.Core.html#844" class="Function Operator">≢</a> <a id="7349" href="MidnightExample.Ledger.html#3511" class="Field">count</a> <a id="7355" href="MidnightExample.Ledger.html#6775" class="Generalizable">s&#39;</a>
<a id="7358" href="MidnightExample.Ledger.html#7291" class="Function">LEDGER-property₃</a> <a id="7375" class="Symbol">{</a><a id="7376" class="Argument">b</a> <a id="7378" class="Symbol">=</a> <a id="7380" href="MidnightExample.Ledger.html#7380" class="Bound">b</a><a id="7381" class="Symbol">}</a> <a id="7383" href="MidnightExample.Ledger.html#7383" class="Bound">h</a> <a id="7385" class="Keyword">with</a>
  <a id="7392" class="Symbol">(</a><a id="7393" href="Axiom.Set.Sum.html#1683" class="Function">Σˡ[</a> <a id="7397" href="MidnightExample.Ledger.html#7397" class="Bound">x</a> <a id="7399" href="Axiom.Set.Sum.html#1683" class="Function">←</a> <a id="7401" href="MidnightExample.Ledger.html#2621" class="Field">Block.body</a> <a id="7412" href="MidnightExample.Ledger.html#7380" class="Bound">b</a> <a id="7414" href="Axiom.Set.Sum.html#1683" class="Function">]</a> <a id="7416" href="MidnightExample.Ledger.html#2041" class="Function">txDelta</a> <a id="7424" href="MidnightExample.Ledger.html#7397" class="Bound">x</a><a id="7425" class="Symbol">)</a> <a id="7427" href="Interface.DecEq.html#243" class="Field Operator">≟</a> <a id="7429" href="Data.Integer.Base.html#1518" class="Function">0ℤ</a> <a id="7432" class="Symbol">|</a> <a id="7434" href="MidnightExample.Ledger.html#2787" class="Function">computeBlockHash</a> <a id="7451" href="MidnightExample.Ledger.html#7380" class="Bound">b</a> <a id="7453" href="Interface.DecEq.html#243" class="Field Operator">≟</a> <a id="7455" href="MidnightExample.Ledger.html#2494" class="Function">Block.blockHash</a> <a id="7471" href="MidnightExample.Ledger.html#7380" class="Bound">b</a> <a id="7473" class="Symbol">|</a> <a id="7475" href="MidnightExample.Ledger.html#7383" class="Bound">h</a>
<a id="7477" class="Symbol">...</a> <a id="7481" class="Symbol">|</a> <a id="7483" href="Relation.Nullary.Decidable.Core.html#1650" class="InductiveConstructor">no</a> <a id="7486" href="MidnightExample.Ledger.html#7486" class="Bound">acc≢0</a> <a id="7492" class="Symbol">|</a> <a id="7494" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="7498" class="Symbol">_</a> <a id="7500" class="Symbol">|</a> <a id="7502" href="Agda.Builtin.Equality.html#190" class="InductiveConstructor">refl</a> <a id="7507" class="Symbol">=</a> <a id="7509" href="MidnightExample.Ledger.html#6909" class="Function">lemma</a> <a id="7515" href="MidnightExample.Ledger.html#7486" class="Bound">acc≢0</a>
<a id="7521" class="Symbol">...</a> <a id="7525" class="Symbol">|</a> <a id="7527" href="Relation.Nullary.Decidable.Core.html#1650" class="InductiveConstructor">no</a> <a id="7530" class="Symbol">_</a>     <a id="7536" class="Symbol">|</a> <a id="7538" href="Relation.Nullary.Decidable.Core.html#1650" class="InductiveConstructor">no</a> <a id="7541" class="Symbol">_</a>  <a id="7544" class="Symbol">|</a> <a id="7546" class="Symbol">()</a>
<a id="7549" class="Symbol">...</a> <a id="7553" class="Symbol">|</a> <a id="7555" href="Relation.Nullary.Decidable.Core.html#1613" class="InductiveConstructor">yes</a> <a id="7559" class="Symbol">_</a>    <a id="7564" class="Symbol">|</a> <a id="7566" class="Symbol">_</a>     <a id="7572" class="Symbol">|</a> <a id="7574" class="Symbol">()</a>
<a id="7577" class="Markup">\end{code}</a><a id="7587" class="Background">
\caption{Three proofs that the counter doesn&#39;t stay constant}
\end{figure*}
</a></pre></body></html>